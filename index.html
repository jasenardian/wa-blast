<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - WA Blast Pro</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
    <style>
        :root {
            --sidebar-width: 260px;
            --primary-gradient: linear-gradient(135deg, #004e00, #004e04);
            --dark-gradient: linear-gradient(135deg, #0f2027, #203a43, #2c5364);
        }
        body {
            overflow-x: hidden;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f3f4f6;
        }
        
        /* Layout */
        #wrapper {
            display: flex;
            width: 100%;
            height: 100vh;
            overflow: hidden;
        }
        
        /* Sidebar */
        #sidebar-wrapper {
            min-height: 100vh;
            width: var(--sidebar-width);
            margin-left: 0;
            background: var(--dark-gradient);
            color: white;
            transition: margin 0.25s ease-out;
            display: flex;
            flex-direction: column;
            box-shadow: 4px 0 10px rgba(0,0,0,0.1);
            z-index: 1000;
        }
        #sidebar-wrapper .sidebar-heading {
            padding: 1.5rem 1.25rem;
            font-size: 1.4rem;
            font-weight: bold;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            background: rgba(0,0,0,0.1);
        }
        #sidebar-wrapper .list-group {
            width: var(--sidebar-width);
            padding: 10px;
        }
        #sidebar-wrapper .list-group-item {
            background-color: transparent;
            color: rgba(255,255,255,0.8);
            border: none;
            padding: 12px 20px;
            margin-bottom: 5px;
            border-radius: 10px;
            transition: all 0.2s;
        }
        #sidebar-wrapper .list-group-item:hover {
            background-color: rgba(255,255,255,0.1);
            color: #fff;
            padding-left: 25px;
        }
        #sidebar-wrapper .list-group-item.active {
            background: var(--primary-gradient);
            color: white;
            font-weight: 600;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
        }
        
        /* Content */
        #page-content-wrapper {
            flex: 1;
            width: 100%;
            overflow-y: auto;
            background: #f3f4f6;
        }
        
        /* Top Navbar */
        .navbar-custom {
            background: white;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            padding: 15px 20px;
        }
        
        /* Cards */
        .card-custom {
            border: none;
            border-radius: 15px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.05);
            background: white;
            margin-bottom: 25px;
            transition: transform 0.2s;
        }
        .card-custom:hover {
            transform: translateY(-2px);
        }
        .card-header-custom {
            background: white;
            border-bottom: 1px solid #eee;
            padding: 20px;
            font-weight: 700;
            color: #2c3e50;
            border-radius: 15px 15px 0 0 !important;
        }
        
        /* Balance Card */
        .balance-widget {
            background: var(--primary-gradient);
            color: white;
            border-radius: 15px;
            padding: 25px;
            position: relative;
            overflow: hidden;
        }
        .balance-widget::after {
            content: "";
            position: absolute;
            top: -50px;
            right: -50px;
            width: 150px;
            height: 150px;
            background: rgba(255,255,255,0.1);
            border-radius: 50%;
        }
        
        /* Logs */
        #logs {
            background: #1e1e1e;
            color: #00ff00;
            height: 350px;
            overflow-y: auto;
            border-radius: 10px;
            font-family: 'Courier New', Courier, monospace;
            padding: 15px;
            font-size: 0.85rem;
            border: 1px solid #333;
        }
        .log-entry { margin-bottom: 5px; border-bottom: 1px solid #333; padding-bottom: 2px; }
        .log-time { color: #888; margin-right: 10px; font-size: 0.8em; }
        
        /* Mobile Toggle */
        @media (max-width: 768px) {
            #sidebar-wrapper {
                margin-left: calc(-1 * var(--sidebar-width));
                position: fixed;
                height: 100%;
            }
            #wrapper.toggled #sidebar-wrapper {
                margin-left: 0;
            }
            .navbar-custom {
                padding: 10px;
            }
        }
        
        /* QR Placeholder */
        .qr-placeholder {
            width: 100%;
            max-width: 250px;
            aspect-ratio: 1;
            background: #f8f9fa;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto;
            border: 2px dashed #ccc;
            border-radius: 15px;
        }

        /* Status Badges */
        .status-badge {
            font-size: 0.9em;
            padding: 8px 15px;
            border-radius: 30px;
        }
        .status-waiting { background: #fff3cd; color: #856404; }
        .status-ready { background: #d1e7dd; color: #0f5132; }
        
        /* Admin */
        #adminPanel { display: none; }
        .badge-connected { background-color: #d1e7dd; color: #0f5132; }
        .badge-disconnected { background-color: #f8d7da; color: #842029; }

        /* Professional Transaction History */
        .transaction-list {
            padding: 0;
            background: #fff;
        }
        .transaction-item {
            border-bottom: 1px solid #f0f0f0;
            padding: 16px 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            transition: background 0.2s;
        }
        .transaction-item:last-child { border-bottom: none; }
        .transaction-item:hover { background-color: #fcfcfc; }
        
        .tx-icon {
            width: 42px;
            height: 42px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            margin-right: 15px;
            flex-shrink: 0;
        }
        .tx-icon.pending { background: #fff8e1; color: #f1c40f; }
        .tx-icon.success { background: #e8f5e9; color: #2ecc71; }
        .tx-icon.failed { background: #ffebee; color: #e74c3c; }

        .tx-details {
            flex-grow: 1;
            min-width: 0;
        }
        .tx-title {
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 2px;
            font-size: 0.95rem;
        }
        .tx-meta {
            font-size: 0.75rem;
            color: #95a5a6;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .tx-right {
            text-align: right;
            margin-left: 15px;
            flex-shrink: 0;
        }
        .tx-amount {
            font-weight: 700;
            color: #2c3e50;
            font-size: 1rem;
            display: block;
        }
        .tx-status-badge {
            font-size: 0.65rem;
            padding: 3px 10px;
            border-radius: 12px;
            text-transform: uppercase;
            font-weight: 700;
            letter-spacing: 0.5px;
            display: inline-block;
            margin-top: 4px;
        }
        .bg-status-pending { background: #fff3cd; color: #b7950b; }
        .bg-status-success { background: #d1e7dd; color: #198754; }
        .bg-status-failed { background: #f8d7da; color: #dc3545; }

        /* --- New Mobile Dashboard Design --- */
        .hero-card {
            background: var(--primary-gradient);
            border-radius: 20px;
            padding: 30px;
            color: white;
            box-shadow: 0 10px 25px rgba(0, 176, 155, 0.3);
            margin-bottom: 25px;
            position: relative;
            overflow: hidden;
        }
        .hero-card::before {
            content: "";
            position: absolute;
            top: -50%;
            left: -10%;
            width: 300px;
            height: 300px;
            background: rgba(255,255,255,0.1);
            border-radius: 50%;
        }
        .hero-card .balance-label {
            font-size: 0.9rem;
            opacity: 0.9;
            margin-bottom: 5px;
        }
        .hero-card .balance-amount {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 20px;
            letter-spacing: -1px;
        }
        .hero-actions {
            display: flex;
            gap: 15px;
        }
        .hero-btn {
            background: rgba(255,255,255,0.2);
            border: 1px solid rgba(255,255,255,0.3);
            color: white;
            padding: 10px 20px;
            border-radius: 12px;
            flex: 1;
            text-align: center;
            backdrop-filter: blur(5px);
            transition: all 0.2s;
            text-decoration: none;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            font-weight: 600;
        }
        .hero-btn:hover {
            background: rgba(255,255,255,0.3);
            color: white;
            transform: translateY(-2px);
        }

        .status-overview-card {
            background: white;
            border-radius: 20px;
            padding: 25px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.03);
            text-align: center;
            height: 100%;
        }
        .status-icon-large {
            width: 80px;
            height: 80px;
            margin: 0 auto 15px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2.5rem;
            transition: all 0.3s;
        }
        .status-icon-large.connected { background: #d1e7dd; color: #198754; }
        .status-icon-large.waiting { background: #fff3cd; color: #ffc107; }
        .status-icon-large.disconnected { background: #f8d7da; color: #dc3545; }

        .dashboard-section-title {
            font-weight: 700;
            color: #2c3e50;
            margin-bottom: 15px;
            font-size: 1.1rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        /* --- Commission Info Styles --- */
        .commission-info-link {
            position: absolute;
            top: 20px;
            right: 20px;
            color: rgba(255,255,255,0.8);
            cursor: pointer;
            transition: color 0.2s;
            background: rgba(255,255,255,0.1);
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
        }
        .commission-info-link:hover {
            color: white;
            background: rgba(255,255,255,0.2);
        }
        
        .commission-detail-item {
            display: flex;
            justify-content: space-between;
            padding: 12px 0;
            border-bottom: 1px dashed #eee;
        }
        .commission-detail-item:last-child { border-bottom: none; }
        .commission-label { color: #6c757d; font-size: 0.9rem; }
        .commission-value { font-weight: 600; color: #2c3e50; }

        .info-pill {
            background: #e7f1ff;
            color: #0d6efd;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
            display: inline-block;
            margin-right: 5px;
            margin-bottom: 5px;
        }

        /* --- New Admin Panel Mobile Design --- */
        .admin-stat-card {
            border-radius: 16px;
            padding: 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 15px;
            transition: transform 0.2s;
        }
        .admin-stat-card:active { transform: scale(0.98); }
        .admin-stat-card.success { background: #d1e7dd; color: #0f5132; }
        .admin-stat-card.danger { background: #f8d7da; color: #842029; }
        
        .stat-icon-wrapper {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            background: rgba(255,255,255,0.5);
        }
        .stat-content h3 { font-size: 2rem; margin: 0; font-weight: 800; }
        .stat-content span { font-size: 0.9rem; font-weight: 600; opacity: 0.8; }

        .member-list-item {
            background: white;
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 10px;
            border: 1px solid #f0f0f0;
            box-shadow: 0 2px 5px rgba(0,0,0,0.02);
            position: relative;
        }
        .member-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        .member-name { font-weight: 700; color: #2c3e50; font-size: 1rem; }
        .member-role { font-size: 0.7rem; padding: 2px 8px; border-radius: 4px; background: #e9ecef; color: #495057; text-transform: uppercase; font-weight: bold; }
        
        .member-details {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.9rem;
        }
        .member-balance { font-weight: 700; color: #198754; }
        
        .member-actions {
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px dashed #eee;
            display: flex;
            gap: 8px;
            justify-content: flex-end;
        }
        .btn-action-icon {
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 8px;
            border: 1px solid #dee2e6;
            color: #6c757d;
            background: white;
            transition: all 0.2s;
        }
        .btn-action-icon:hover { background: #f8f9fa; color: #000; }
        .btn-action-icon.danger { color: #dc3545; border-color: #f8d7da; }
        .btn-action-icon.success { color: #198754; border-color: #d1e7dd; }
        .btn-action-icon.warning { color: #ffc107; border-color: #fff3cd; }

        .status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 5px;
        }
        .status-dot.connected { background: #198754; box-shadow: 0 0 5px #198754; }
        .status-dot.disconnected { background: #dc3545; }

    </style>
</head>
<body>

<div id="wrapper">
    <!-- Sidebar -->
    <div id="sidebar-wrapper">
        <div class="sidebar-heading text-center">
            <i class="bi bi-whatsapp"></i> WA Blast Pro
        </div>
        <div class="list-group list-group-flush mt-3">
            <a href="#dashboard" class="list-group-item list-group-item-action active" onclick="showSection('dashboard', this)">
                <i class="bi bi-speedometer2 me-2"></i> Dashboard
            </a>
            <a href="#admin" id="nav-admin" class="list-group-item list-group-item-action" style="display:none;" onclick="showSection('admin', this)">
                <i class="bi bi-shield-lock me-2"></i> Admin Panel
            </a>
            <a href="/riwayat_blast.html" id="nav-blast-history" class="list-group-item list-group-item-action" style="display:none;">
                <i class="bi bi-broadcast me-2"></i> Riwayat Blast
            </a>
            <a href="https://t.me/jstogel" target="_blank" class="list-group-item list-group-item-action">
                <i class="bi bi-telegram me-2"></i> Hubungi Kami
            </a>
            <a href="/logout" class="list-group-item list-group-item-action mt-auto text-danger">
                <i class="bi bi-box-arrow-left me-2"></i> Logout
            </a>
        </div>
        <div class="mt-auto p-3 text-center small text-white-50">
            &copy; 2024 WA Blast Pro
        </div>
    </div>

    <!-- Page Content -->
    <div id="page-content-wrapper">
        <!-- Top Navbar -->
        <nav class="navbar navbar-expand-lg navbar-custom sticky-top">
            <div class="container-fluid">
                <button class="btn btn-light shadow-sm" id="menu-toggle"><i class="bi bi-list"></i></button>
                
                <div class="ms-auto d-flex align-items-center">
                    <div class="dropdown">
                        <a href="#" class="d-flex align-items-center text-decoration-none dropdown-toggle text-dark" id="dropdownUser1" data-bs-toggle="dropdown" aria-expanded="false">
                            <div class="bg-primary text-white rounded-circle d-flex align-items-center justify-content-center me-2" style="width: 35px; height: 35px;">
                                <i class="bi bi-person-fill"></i>
                            </div>
                            <span class="fw-bold me-1" id="userInfoName">Loading...</span>
                        </a>
                        <ul class="dropdown-menu dropdown-menu-end shadow" aria-labelledby="dropdownUser1">
                            <li><span class="dropdown-item-text text-muted small" id="userInfoRole">Role: ...</span></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item" href="#" data-bs-toggle="modal" data-bs-target="#changePasswordModal"><i class="bi bi-key me-2"></i> Ganti Password</a></li>
                            <li><a class="dropdown-item text-danger" href="/logout"><i class="bi bi-box-arrow-right me-2"></i> Logout</a></li>
                        </ul>
                    </div>
                </div>
            </div>
        </nav>

        <div class="container-fluid p-4">
            
            <!-- SECTION: DASHBOARD -->
            <div id="section-dashboard">
                
                <!-- Hero Section: Wallet Style -->
                <div class="row mb-4">
                    <div class="col-12">
                        <div class="hero-card">
                            <div class="balance-label">
                                Saldo Komisi Anda
                                <span class="badge bg-white bg-opacity-25 ms-2" style="font-weight: normal; font-size: 0.7em;">IDR</span>
                            </div>
                            <div class="balance-amount" id="userBalance">Rp 0</div>
                            
                            <a class="commission-info-link" data-bs-toggle="modal" data-bs-target="#commissionInfoModal" title="Informasi Komisi">
                                <i class="bi bi-info-lg"></i>
                            </a>

                            <div class="hero-actions mb-3">
                                <a href="#" class="hero-btn" data-bs-toggle="modal" data-bs-target="#withdrawModal">
                                    <i class="bi bi-arrow-up-circle"></i> Tarik
                                </a>
                                <a href="#" class="hero-btn" onclick="showHistoryModal()">
                                    <i class="bi bi-clock-history"></i> Riwayat
                                </a>
                            </div>
                            <div class="hero-actions">
                                <a href="#" class="hero-btn" onclick="showMyBlastHistory()">
                                    <i class="bi bi-send-check"></i> Rincian Blast
                                </a>
                            </div>
                            
                            <div class="mt-3 pt-3 border-top border-white border-opacity-25 d-flex align-items-center justify-content-between text-white-50 small">
                                <span><i class="bi bi-calendar-check me-1"></i> Bulan Ini</span>
                                <span class="text-white fw-bold" id="monthlyCommission">Rp 0</span>
                            </div>
                        </div>
                    </div>
                </div>

    <!-- Right Column: Info & Logs -->
                    <div class="col-lg-7">
                        
                        <!-- Info Card -->
                        <div class="card card-custom bg-info bg-opacity-10 border-0 mb-4">
                            <div class="card-body d-flex align-items-start">
                                <i class="bi bi-info-circle-fill text-info fs-4 me-3"></i>
                                <div>
                                    <h6 class="fw-bold text-dark mb-1">Informasi Komisi</h6>
                                    <p class="small text-muted mb-0">
                                        Dapatkan <strong>Rp 650</strong> setiap pesan yang terkirim melalui perangkat Anda.
                                        Pastikan koneksi internet stabil agar sesi tidak terputus.
                                    </p>
                                </div>
                            </div>
                        </div>

                <!-- Main Grid -->
                <div class="row g-4">
                    
                    <!-- Left Column: Status & QR -->
                    <div class="col-lg-5 mb-4">
                        <div class="status-overview-card">
                            <h5 class="dashboard-section-title justify-content-center">Status Perangkat</h5>
                            
                            <!-- Status Icon Dynamic -->
                            <div id="statusIconLarge" class="status-icon-large waiting">
                                <i class="bi bi-qr-code"></i>
                            </div>
                            
                            <h4 id="statusTextLarge" class="fw-bold mb-1">Menunggu Koneksi</h4>
                              <h6 id="statusTextSmall" class="fw-bold mb-1">Mohon Tunggu QR akan muncul 1-3 menit</h6>
                            <p id="statusDescLarge" class="text-muted small mb-4">Silakan scan QR Code untuk menghubungkan WhatsApp.</p>

                            <!-- QR Area (Hidden when connected) -->
                            <div id="qrAreaContainer">
                                <div id="qrCode" class="mb-3 d-flex justify-content-center">
                                    <div class="qr-placeholder text-muted">
                                        <small>Menunggu Server...</small>
                                    </div>
                                </div>
                                <p class="text-muted small">Buka WhatsApp > Perangkat Tertaut > Tautkan Perangkat</p>
                            </div>

                            <div class="d-flex justify-content-center gap-2 mt-4">
                                <button class="btn btn-outline-primary rounded-pill px-4" onclick="checkDeviceStatus()">
                                    <i class="bi bi-arrow-clockwise"></i> Refresh
                                </button>
                                <button class="btn btn-outline-danger rounded-pill px-4" onclick="restartDevice()">
                                    <i class="bi bi-power"></i> Restart
                                </button>
                            </div>
                        </div>
                    </div>

               

                        <!-- Admin Blast Form (Hidden for Members) -->
                        <div id="adminBlastContainer" style="display: none;">
                            <div class="card card-custom">
                                <div class="card-header-custom"><i class="bi bi-send-fill text-primary"></i> Kirim Pesan (Superadmin)</div>
                                <div class="card-body">
                                    <form id="blastForm">
                                        <!-- Sender Select -->
                                        <div class="mb-3 p-3 bg-light rounded border border-primary border-opacity-25" id="senderSelectContainer">
                                            <label for="senderId" class="form-label fw-bold text-primary small text-uppercase">Kirim Menggunakan:</label>
                                            <select class="form-select form-select-sm border-primary" id="senderId">
                                                <option value="">-- Akun Saya Sendiri --</option>
                                            </select>
                                        </div>

                                        <div class="mb-3">
                                            <label for="numbers" class="form-label fw-bold small text-muted">NOMOR TUJUAN</label>
                                            <textarea class="form-control bg-light" id="numbers" rows="5" placeholder="08123456789&#10;628987654321"></textarea>
                                        </div>

                                        <div class="mb-3">
                                            <label for="message" class="form-label fw-bold small text-muted">ISI PESAN (SPINTAX)</label>
                                            <textarea class="form-control bg-light" id="message" rows="4" placeholder="Halo {Kak|Bro}, promo spesial untukmu!"></textarea>
                                        </div>

                                        <div class="d-grid">
                                            <button type="submit" id="sendBtn" class="btn btn-success btn-lg shadow-sm" disabled>
                                                <i class="bi bi-cursor-fill"></i> Kirim Sekarang
                                            </button>
                                        </div>
                                    </form>
                                </div>
                            </div>
                        </div>

                        <!-- Logs (Optional/Collapsible) -->
                        <div class="card card-custom">
                            <div class="card-header-custom d-flex justify-content-between align-items-center">
                                <span><i class="bi bi-activity"></i> Aktivitas Sistem</span>
                                <button class="btn btn-sm btn-link text-decoration-none" onclick="document.getElementById('logs').innerHTML=''">Clear</button>
                            </div>
                            <div class="card-body p-0">
                                <div id="logs" style="height: 250px;"></div>
                            </div>
                        </div>

                    </div>
                </div>
            </div>

            <!-- SECTION: ADMIN PANEL -->
            <div id="section-admin" style="display: none;">
                <div class="card card-custom" id="adminPanel">
                    <div class="card-header-custom bg-primary text-white d-flex justify-content-between align-items-center" style="background: var(--dark-gradient) !important; color: white !important;">
                        <span><i class="bi bi-shield-lock"></i> Superadmin Control Panel</span>
                        <button class="btn btn-sm btn-light text-dark shadow-sm" onclick="loadAdminData()"><i class="bi bi-arrow-clockwise"></i> Refresh Data</button>
                    </div>
                    <div class="card-body">
                        <ul class="nav nav-tabs nav-tabs-bordered mb-4" id="adminTabs" role="tablist">
                            <li class="nav-item" role="presentation">
                                <button class="nav-link active" id="members-tab" data-bs-toggle="tab" data-bs-target="#members" type="button">
                                    <i class="bi bi-people"></i> Daftar Member
                                </button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="withdrawals-tab" data-bs-toggle="tab" data-bs-target="#withdrawals" type="button">
                                    <i class="bi bi-currency-exchange"></i> Riwayat Penarikan
                                </button>
                            </li>
                        </ul>
                        
                        <div class="tab-content" id="adminTabsContent">
                            <!-- Tab Members -->
                            <div class="tab-pane fade show active" id="members" role="tabpanel">
                                
                                <!-- Modern Stats Cards -->
                                <div class="row g-3 mb-4">
                                    <div class="col-12">
                                        <div class="admin-stat-card success">
                                            <div class="stat-icon-wrapper"><i class="bi bi-wifi"></i></div>
                                            <div class="stat-content text-end">
                                                <span>Terhubung</span>
                                                <h3 id="countConnected">0</h3>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-12">
                                        <div class="admin-stat-card danger">
                                            <div class="stat-icon-wrapper"><i class="bi bi-wifi-off"></i></div>
                                            <div class="stat-content text-end">
                                                <span>Terputus</span>
                                                <h3 id="countDisconnected">0</h3>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div class="d-flex justify-content-between align-items-center mb-3">
                                    <div>
                                        <h5 class="fw-bold m-0 text-dark">Daftar Member</h5>
                                        <small class="text-muted">Kelola pengguna & koneksi</small>
                                    </div>
                                    <button class="btn btn-danger rounded-pill shadow-sm" onclick="restartAllDevices()">
                                        <i class="bi bi-arrow-repeat me-1"></i> Restart Semua
                                    </button>
                                </div>

                                <!-- Filter & Search for Members -->
                                <div class="row g-2 mb-3">
                                    <div class="col-8">
                                        <div class="input-group">
                                            <span class="input-group-text bg-white border-end-0"><i class="bi bi-search text-muted"></i></span>
                                            <input type="text" id="searchMember" class="form-control border-start-0 ps-0" placeholder="Cari username...">
                                        </div>
                                    </div>
                                    <div class="col-4">
                                        <select id="filterMemberStatus" class="form-select">
                                            <option value="all">Semua</option>
                                            <option value="connected">Aktif</option>
                                            <option value="disconnected">Mati</option>
                                        </select>
                                    </div>
                                </div>

                                <!-- Modern Member List (Replaces Table) -->
                                <div id="membersListContainer">
                                    <div class="text-center py-5 text-muted"><span class="spinner-border spinner-border-sm"></span> Memuat...</div>
                                </div>

                            </div>
                            
                            <!-- Tab Withdrawals -->
                            <div class="tab-pane fade" id="withdrawals" role="tabpanel">
                                <h5 class="fw-bold mb-3 mt-2">Permintaan Penarikan</h5>
                                
                                <!-- Filter & Search for Withdrawals -->
                                <div class="row g-2 mb-3">
                                    <div class="col-8">
                                        <div class="input-group">
                                            <span class="input-group-text bg-white border-end-0"><i class="bi bi-search text-muted"></i></span>
                                            <input type="text" id="searchWithdraw" class="form-control border-start-0 ps-0" placeholder="Cari user/bank...">
                                        </div>
                                    </div>
                                    <div class="col-4">
                                        <select id="filterWithdrawStatus" class="form-select">
                                            <option value="all">Semua</option>
                                            <option value="pending">Pending</option>
                                            <option value="success">Sukses</option>
                                            <option value="failed">Gagal</option>
                                        </select>
                                    </div>
                                </div>

                                <!-- Modern Withdrawal List (Replaces Table) -->
                                <div id="adminWithdrawalsList">
                                    <div class="text-center py-5 text-muted"><span class="spinner-border spinner-border-sm"></span> Memuat...</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>
</div>

<!-- Modal Commission Info -->
<div class="modal fade" id="commissionInfoModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow-lg" style="border-radius: 20px;">
            <div class="modal-header bg-primary text-white" style="background: var(--primary-gradient) !important; border-radius: 20px 20px 0 0;">
                <h5 class="modal-title"><i class="bi bi-info-circle"></i> Informasi Komisi</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body p-4">
                <div class="text-center mb-4">
                    <div class="text-muted small mb-1">Total Saldo Tersedia</div>
                    <h2 class="fw-bold text-success" id="infoModalBalance">Rp 0</h2>
                </div>

                <h6 class="fw-bold border-bottom pb-2 mb-3"><i class="bi bi-wallet2 me-2 text-primary"></i> Rincian Saldo</h6>
                <div class="commission-detail-item">
                    <span class="commission-label">Komisi Tersedia</span>
                    <span class="commission-value text-success" id="infoModalAvailable">Rp 0</span>
                </div>
                <div class="commission-detail-item">
                    <span class="commission-label">Komisi Tertunda</span>
                    <span class="commission-value text-warning">Rp 0</span>
                </div>
                <div class="commission-detail-item">
                    <span class="commission-label">Total Ditarik</span>
                    <span class="commission-value text-danger" id="infoModalWithdrawn">Rp 0</span>
                </div>

                <h6 class="fw-bold border-bottom pb-2 mb-3 mt-4"><i class="bi bi-journal-text me-2 text-primary"></i> Ketentuan</h6>
                <div class="mb-3">
                    <span class="info-pill"><i class="bi bi-cash"></i> Min. Tarik Rp 100rb</span>
                    <span class="info-pill"><i class="bi bi-clock"></i> Proses 1x24 Jam</span>
                    <span class="info-pill"><i class="bi bi-calendar-x"></i> Libur: Sabtu/Minggu</span>
                    <span class="info-pill"><i class="bi bi-percent"></i> Admin Fee: Rp 0</span>
                </div>
                
                <div class="alert alert-light border small text-muted mb-0">
                    <i class="bi bi-whatsapp me-1 text-success"></i> ID Akun: <span class="fw-bold text-dark" id="infoModalWaId">-</span><br>
                    <i class="bi bi-clock-history me-1 text-primary"></i> Update Terakhir: <span class="fw-bold text-dark" id="infoModalUpdate">-</span>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal History (Member) -->
<div class="modal fade" id="historyModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable">
        <div class="modal-content border-0 shadow-lg" style="border-radius: 20px;">
            <div class="modal-header bg-success text-white" style="border-radius: 20px 20px 0 0;">
                <h5 class="modal-title"><i class="bi bi-clock-history"></i> Riwayat Penarikan Anda</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body p-0">
                <div class="alert alert-info m-3 small border-0 shadow-sm" role="alert">
                    <i class="bi bi-da-circle-fill me-2"></i>
                    Penarikan akan diproses dalam waktu <strong>1x24 Jam</strong> (Hari Kerja).<br>
                    Hari Sabtu, Minggu & Libur Nasional tidak dihitung.
                </div>
                <!-- New Professional List View -->
                <div id="transactionList" class="transaction-list">
                    <div class="text-center py-5 text-muted">
                        <span class="spinner-border spinner-border-sm"></span> Memuat data...
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal Blast History (Member) -->
<div class="modal fade" id="myBlastHistoryModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable">
        <div class="modal-content border-0 shadow-lg" style="border-radius: 20px;">
            <div class="modal-header bg-primary text-white" style="background: var(--dark-gradient) !important; border-radius: 20px 20px 0 0;">
                <h5 class="modal-title"><i class="bi bi-send-check"></i> Riwayat Blast & Komisi</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body p-0">
                <div class="alert alert-light m-3 small border border-primary border-opacity-25" role="alert">
                    <i class="bi bi-info-circle-fill me-2 text-primary"></i>
                    Berikut adalah daftar pesan yang dikirim menggunakan perangkat WhatsApp Anda.<br>
                    <strong>Sukses</strong> = Komisi Masuk (Rp 650).
                </div>
                
                <div id="myBlastList" class="transaction-list">
                    <div class="text-center py-5 text-muted">
                        <span class="spinner-border spinner-border-sm"></span> Memuat data...
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal Withdraw -->
<div class="modal fade" id="withdrawModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow-lg" style="border-radius: 20px;">
            <div class="modal-header bg-success text-white" style="border-radius: 20px 20px 0 0;">
                <h5 class="modal-title"><i class="bi bi-cash-stack"></i> Form Penarikan Komisi</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body p-4">
                <form id="withdrawForm">
                    <div class="form-floating mb-3">
                        <input type="number" class="form-control" id="wdAmount" required min="100000" placeholder="Jumlah">
                        <label for="wdAmount">Jumlah (Min Rp 100.000)</label>
                    </div>
                    <div class="row g-2 mb-3">
                        <div class="col-md-6">
                            <div class="form-floating">
                                <input type="text" class="form-control" id="wdBank" required placeholder="Bank">
                                <label for="wdBank">Bank (BCA/DANA/dll)</label>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-floating">
                                <input type="number" class="form-control" id="wdRek" required placeholder="No Rek">
                                <label for="wdRek">Nomor Rekening</label>
                            </div>
                        </div>
                    </div>
                    <div class="form-floating mb-3">
                        <input type="text" class="form-control" id="wdName" required placeholder="Nama Pemilik">
                        <label for="wdName">Nama Pemilik Rekening</label>
                    </div>
                    <div class="form-floating mb-4">
                        <input type="text" class="form-control" id="wdWa" required placeholder="No WA">
                        <label for="wdWa">No. WhatsApp (Konfirmasi)</label>
                    </div>
                    <div class="alert alert-info small" role="alert">
                        <i class="bi bi-info-circle-fill me-2"></i>
                        Penarikan akan diproses dalam waktu <strong>1x24 Jam</strong> (Hari Kerja).<br>
                        Hari Sabtu, Minggu & Libur Nasional tidak dihitung.
                    </div>
                    <div class="d-grid">
                        <button type="submit" class="btn btn-success btn-lg rounded-pill shadow">Kirim Permintaan</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Modal Change Password -->
<div class="modal fade" id="changePasswordModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow-lg" style="border-radius: 20px;">
            <div class="modal-header bg-primary text-white" style="border-radius: 20px 20px 0 0;">
                <h5 class="modal-title"><i class="bi bi-shield-lock"></i> Ganti Password</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body p-4">
                <form id="changePasswordForm">
                    <div class="form-floating mb-3">
                        <input type="password" class="form-control" id="oldPassword" required placeholder="Password Lama">
                        <label for="oldPassword">Password Lama</label>
                    </div>
                    <div class="form-floating mb-3">
                        <input type="password" class="form-control" id="newPassword" required minlength="6" placeholder="Password Baru">
                        <label for="newPassword">Password Baru (Min 6 char)</label>
                    </div>
                    <div class="form-floating mb-4">
                        <input type="password" class="form-control" id="confirmPassword" required minlength="6" placeholder="Konfirmasi Password Baru">
                        <label for="confirmPassword">Ulangi Password Baru</label>
                    </div>
                    <div class="d-grid">
                        <button type="submit" class="btn btn-primary btn-lg rounded-pill shadow">Simpan Password Baru</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<script src="/socket.io/socket.io.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
    // --- UI Logic ---
    const wrapper = document.getElementById("wrapper");
    const menuToggle = document.getElementById("menu-toggle");
    
    menuToggle.addEventListener("click", function(e) {
        e.preventDefault();
        wrapper.classList.toggle("toggled");
    });

    function showSection(sectionName, element) {
        // Hide all sections
        document.getElementById('section-dashboard').style.display = 'none';
        document.getElementById('section-admin').style.display = 'none';
        
        // Remove active class from navs
        document.querySelectorAll('.list-group-item').forEach(el => el.classList.remove('active'));
        
        // Show target
        document.getElementById('section-' + sectionName).style.display = 'block';
        if(element) element.classList.add('active');
    }

    // --- App Logic ---
    const socket = io();
    const logsDiv = document.getElementById('logs');
    const qrDiv = document.getElementById('qrCode');
    const statusIconLarge = document.getElementById('statusIconLarge');
    const statusTextLarge = document.getElementById('statusTextLarge');
    const statusDescLarge = document.getElementById('statusDescLarge');
    const qrAreaContainer = document.getElementById('qrAreaContainer');
    const sendBtn = document.getElementById('sendBtn');
    
    let currentUser = null;

    // --- Device Management ---
    function checkDeviceStatus() {
        fetch('/api/device/status')
            .then(res => res.json())
            .then(data => {
                updateStatusUI(data.status, data.info);
            })
            .catch(err => Swal.fire('Error', 'Gagal cek status', 'error'));
    }

    function updateStatusUI(status, info) {
        // Reset classes
        statusIconLarge.classList.remove('connected', 'waiting', 'disconnected');
        
        if (status === 'connected') {
            statusIconLarge.classList.add('connected');
            statusIconLarge.innerHTML = '<i class="bi bi-check-lg"></i>';
            statusTextLarge.innerText = 'Terhubung';
            statusTextLarge.className = 'fw-bold mb-1 text-success';
            statusDescLarge.innerText = `WhatsApp aktif: ${info.pushname} (${info.wid.user})`;
            
            qrAreaContainer.style.display = 'none';
            if(sendBtn) sendBtn.disabled = false;
        } 
        else if (status === 'waiting_qr') {
            statusIconLarge.classList.add('waiting');
            statusIconLarge.innerHTML = '<i class="bi bi-qr-code"></i>';
            statusTextLarge.innerText = 'Menunggu Scan';
            statusTextLarge.className = 'fw-bold mb-1 text-warning';
            statusDescLarge.innerText = 'Silakan scan QR Code di bawah ini.';
            
            qrAreaContainer.style.display = 'block';
            qrDiv.innerHTML = `<div class="qr-placeholder text-muted"><small>Menunggu QR...</small></div>`;
        } 
        else {
            statusIconLarge.classList.add('disconnected');
            statusIconLarge.innerHTML = '<i class="bi bi-x-lg"></i>';
            statusTextLarge.innerText = 'Terputus';
            statusTextLarge.className = 'fw-bold mb-1 text-danger';
            statusDescLarge.innerText = 'Sesi WhatsApp tidak terhubung.';
            
            qrAreaContainer.style.display = 'none';
        }
    }

    function restartDevice() {
        Swal.fire({
            title: 'Restart Koneksi?',
            text: "Ini akan memutus sesi saat ini dan meminta scan QR ulang.",
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#d33',
            cancelButtonColor: '#3085d6',
            confirmButtonText: 'Ya, Restart!'
        }).then((result) => {
            if (result.isConfirmed) {
                Swal.fire({
                    title: 'Merestart...',
                    didOpen: () => Swal.showLoading()
                });
                
                fetch('/api/device/restart', { method: 'POST' })
                    .then(res => res.json())
                    .then(data => {
                        Swal.fire('Berhasil', data.message, 'success');
                        // Reset UI ke mode waiting
                        updateStatusUI('waiting_qr', null);
                        if(sendBtn) sendBtn.disabled = true;
                    })
                    .catch(err => Swal.fire('Error', 'Gagal restart device', 'error'));
            }
        });
    }

    const formatRupiah = (number) => {
        return new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', minimumFractionDigits: 0 }).format(number);
    }

    function initUser() {
        fetch('/api/me')
            .then(res => res.json())
            .then(user => {
                currentUser = user;
                console.log('Logged in as:', user.username, 'Role:', user.role);
                
                // Update Navbar Info
                document.getElementById('userInfoName').innerText = user.username;
                document.getElementById('userInfoRole').innerText = 'Role: ' + user.role.toUpperCase();
                
                // Update Balance UI
                const fmtBalance = formatRupiah(user.balance);
                document.getElementById('userBalance').innerText = fmtBalance;
                document.getElementById('monthlyCommission').innerText = fmtBalance; 

                // Update Info Modal Data
                document.getElementById('infoModalBalance').innerText = fmtBalance;
                document.getElementById('infoModalAvailable').innerText = fmtBalance;
                document.getElementById('infoModalWaId').innerText = user.username;
                document.getElementById('infoModalUpdate').innerText = new Date().toLocaleString('id-ID', { 
                    day: 'numeric', month: 'short', year: 'numeric', 
                    hour: '2-digit', minute: '2-digit' 
                });
                
                // Fetch Total Withdrawn for Modal
                fetch('/api/me/withdrawals')
                    .then(res => res.json())
                    .then(data => {
                        const totalWithdrawn = data
                            .filter(w => w.status === 'success')
                            .reduce((sum, w) => sum + w.amount, 0);
                        document.getElementById('infoModalWithdrawn').innerText = formatRupiah(totalWithdrawn);
                    });

                // Join Socket Room
                socket.emit('join', user.id);

                // Setup Admin View if applicable
                if (user.role === 'superadmin') {
                    document.getElementById('nav-admin').style.display = 'block';
                    document.getElementById('nav-blast-history').style.display = 'block';
                    document.getElementById('adminPanel').style.display = 'block';
                    document.getElementById('adminBlastContainer').style.display = 'block'; // Show blast form
                    document.getElementById('senderSelectContainer').style.display = 'block';
                    loadAdminData();
                }
            })
            .catch(err => console.error('Failed to get user info', err));
    }

    initUser();

    function showHistoryModal() {
        const modal = new bootstrap.Modal(document.getElementById('historyModal'));
        modal.show();
        
        const listContainer = document.getElementById('transactionList');
        listContainer.innerHTML = '<div class="text-center py-5 text-muted"><span class="spinner-border spinner-border-sm"></span> Memuat data...</div>';

        fetch('/api/me/withdrawals')
            .then(res => res.json())
            .then(data => {
                listContainer.innerHTML = '';
                
                if(data.length === 0) {
                    listContainer.innerHTML = '<div class="text-center py-5 text-muted"><i class="bi bi-inbox fs-1 d-block mb-2 opacity-25"></i>Belum ada riwayat penarikan.</div>';
                    return;
                }

                data.forEach(w => {
                    let statusClass = 'pending';
                    let iconClass = 'bi-hourglass-split';
                    let statusLabel = 'PENDING';
                    
                    if(w.status === 'success') {
                        statusClass = 'success';
                        iconClass = 'bi-check-lg';
                        statusLabel = 'BERHASIL';
                    }
                    if(w.status === 'failed') {
                        statusClass = 'failed';
                        iconClass = 'bi-x-lg';
                        statusLabel = 'GAGAL';
                    }

                    const date = new Date(w.created_at).toLocaleString('id-ID', { 
                        day: 'numeric', month: 'short', year: 'numeric', 
                        hour: '2-digit', minute: '2-digit' 
                    });

                    const itemHtml = `
                        <div class="transaction-item">
                            <div class="tx-icon ${statusClass}">
                                <i class="bi ${iconClass}"></i>
                            </div>
                            <div class="tx-details">
                                <div class="tx-title">${w.bank_name.toUpperCase()} - ${w.account_number}</div>
                                <div class="tx-meta">
                                    <i class="bi bi-calendar3"></i> ${date}
                                </div>
                            </div>
                            <div class="tx-right">
                                <span class="tx-amount">${formatRupiah(w.amount)}</span>
                                <span class="tx-status-badge bg-status-${statusClass}">${statusLabel}</span>
                            </div>
                        </div>
                    `;
                    listContainer.innerHTML += itemHtml;
                });
            })
            .catch(err => {
                console.error(err);
                listContainer.innerHTML = '<div class="text-center py-5 text-danger">Gagal memuat data.</div>';
            });
    }

    function showMyBlastHistory() {
        const modal = new bootstrap.Modal(document.getElementById('myBlastHistoryModal'));
        modal.show();
        
        const listContainer = document.getElementById('myBlastList');
        listContainer.innerHTML = '<div class="text-center py-5 text-muted"><span class="spinner-border spinner-border-sm"></span> Memuat data...</div>';

        fetch('/api/me/blast-logs')
            .then(res => res.json())
            .then(data => {
                listContainer.innerHTML = '';
                
                if(data.length === 0) {
                    listContainer.innerHTML = '<div class="text-center py-5 text-muted"><i class="bi bi-send-slash fs-1 d-block mb-2 opacity-25"></i>Belum ada riwayat blast.</div>';
                    return;
                }

                data.forEach(d => {
                    let statusClass = 'failed';
                    let iconClass = 'bi-x-lg';
                    let statusLabel = 'GAGAL';
                    let amountLabel = '<span class="text-muted">Rp 0</span>';
                    
                    if(d.status === 'success') {
                        statusClass = 'success';
                        iconClass = 'bi-check-lg';
                        statusLabel = 'SUKSES';
                        amountLabel = '<span class="text-success">+Rp 650</span>';
                    }

                    // Mode: jika sender_mode != 'self', berarti dipinjam admin
                    let modeInfo = '';
                    if (d.sender_mode !== 'self') {
                        modeInfo = '<span class="badge bg-info bg-opacity-10 text-info border border-info border-opacity-25 ms-2" style="font-size:0.65em">DIPINJAM ADMIN</span>';
                    }

                    const date = new Date(d.created_at).toLocaleString('id-ID', { 
                        day: 'numeric', month: 'short', year: 'numeric', 
                        hour: '2-digit', minute: '2-digit' 
                    });

                    const itemHtml = `
                        <div class="transaction-item">
                            <div class="tx-icon ${statusClass}">
                                <i class="bi ${iconClass}"></i>
                            </div>
                            <div class="tx-details">
                                <div class="tx-title">
                                    Ke: ${d.target_number.replace('@c.us', '')}
                                    ${modeInfo}
                                </div>
                                <div class="tx-meta">
                                    <i class="bi bi-clock"></i> ${date}
                                </div>
                            </div>
                            <div class="tx-right">
                                <span class="tx-amount" style="font-size: 0.9rem;">${amountLabel}</span>
                                <span class="tx-status-badge bg-status-${statusClass}">${statusLabel}</span>
                            </div>
                        </div>
                    `;
                    listContainer.innerHTML += itemHtml;
                });
            })
            .catch(err => {
                console.error(err);
                listContainer.innerHTML = '<div class="text-center py-5 text-danger">Gagal memuat data.</div>';
            });
    }

    // --- Admin Global Data Store ---
    let allUsersData = [];
    let allWithdrawalsData = [];

    // --- Search & Filter Logic ---
    function setupAdminFilters() {
        // Member Filter
        const filterMember = () => {
            const search = document.getElementById('searchMember').value.toLowerCase();
            const status = document.getElementById('filterMemberStatus').value;
            
            const filtered = allUsersData.filter(u => {
                const matchSearch = u.username.toLowerCase().includes(search);
                const matchStatus = status === 'all' || 
                                  (status === 'connected' && u.status === 'connected') || 
                                  (status === 'disconnected' && u.status !== 'connected');
                return matchSearch && matchStatus;
            });
            renderMemberList(filtered);
        };
        document.getElementById('searchMember').addEventListener('keyup', filterMember);
        document.getElementById('filterMemberStatus').addEventListener('change', filterMember);

        // Withdrawal Filter
        const filterWithdraw = () => {
            const search = document.getElementById('searchWithdraw').value.toLowerCase();
            const status = document.getElementById('filterWithdrawStatus').value;
            
            const filtered = allWithdrawalsData.filter(w => {
                const matchSearch = w.username.toLowerCase().includes(search) || 
                                  w.bank_name.toLowerCase().includes(search) || 
                                  w.account_name.toLowerCase().includes(search);
                const matchStatus = status === 'all' || w.status === status;
                return matchSearch && matchStatus;
            });
            renderWithdrawalList(filtered);
        };
        document.getElementById('searchWithdraw').addEventListener('keyup', filterWithdraw);
        document.getElementById('filterWithdrawStatus').addEventListener('change', filterWithdraw);
    }

    function renderMemberList(users) {
        const listContainer = document.getElementById('membersListContainer');
        const senderSelect = document.getElementById('senderId');
        
        listContainer.innerHTML = '';
        senderSelect.innerHTML = '<option value="">-- Gunakan Akun Saya Sendiri --</option>';

        if(users.length === 0) {
            listContainer.innerHTML = '<div class="text-center py-4 text-muted">Tidak ada member ditemukan.</div>';
            return;
        }

        const connectedMembers = allUsersData.filter(u => u.id !== currentUser.id && u.status === 'connected');
        if (connectedMembers.length > 0) {
             senderSelect.innerHTML += `<option value="random" style="font-weight:bold; color:blue;">--  Rotasi Semua Member (${connectedMembers.length} Aktif) --</option>`;
        }

        users.forEach(u => {
            const statusClass = u.status === 'connected' ? 'connected' : 'disconnected';
            
            const itemHtml = `
                <div class="member-list-item">
                    <div class="member-header">
                        <div class="d-flex align-items-center">
                            <div class="status-dot ${statusClass}"></div>
                            <span class="member-name me-2">${u.username}</span>
                            <span class="member-role">${u.role}</span>
                        </div>
                        <small class="text-muted">#${u.id}</small>
                    </div>
                    
                    <div class="member-details">
                        <span class="text-muted small">Saldo Komisi:</span>
                        <span class="member-balance">${formatRupiah(u.balance)}</span>
                    </div>

                    <div class="member-actions">
                        <button class="btn-action-icon success" onclick="addBalance(${u.id}, '${u.username}')" title="Isi Saldo">
                            <i class="bi bi-cash-coin"></i>
                        </button>
                        <button class="btn-action-icon" onclick="showMemberStatus(${u.id}, '${u.username}', '${u.status}', '${u.info ? u.info.pushname : ''}', '${u.info ? u.info.wid.user : ''}')" title="Cek Status WA">
                            <i class="bi bi-info-circle"></i>
                        </button>
                        <button class="btn-action-icon warning" onclick="resetUserPassword(${u.id}, '${u.username}')" title="Reset Password">
                            <i class="bi bi-key"></i>
                        </button>
                        <button class="btn-action-icon danger" onclick="restartMemberDevice(${u.id}, '${u.username}')" title="Restart Koneksi">
                            <i class="bi bi-power"></i>
                        </button>
                    </div>
                </div>
            `;
            listContainer.innerHTML += itemHtml;

            if (u.id !== currentUser.id && u.status === 'connected') {
                senderSelect.innerHTML += `<option value="${u.id}">${u.username} (Connected)</option>`;
            }
        });
    }

    function renderWithdrawalList(withdrawals) {
        const listContainer = document.getElementById('adminWithdrawalsList');
        listContainer.innerHTML = '';
        
        if(withdrawals.length === 0) {
            listContainer.innerHTML = '<div class="text-center py-5 text-muted">Belum ada data penarikan.</div>';
            return;
        }

        withdrawals.forEach(w => {
            let statusBadge = '';
            let cardBorder = '';
            
            if(w.status === 'success') {
                statusBadge = '<span class="badge bg-success rounded-pill"><i class="bi bi-check-circle me-1"></i>SUKSES</span>';
                cardBorder = 'border-success';
            } else if(w.status === 'failed') {
                statusBadge = '<span class="badge bg-danger rounded-pill"><i class="bi bi-x-circle me-1"></i>GAGAL</span>';
                cardBorder = 'border-danger';
            } else {
                statusBadge = '<span class="badge bg-warning text-dark rounded-pill"><i class="bi bi-hourglass-split me-1"></i>PENDING</span>';
                cardBorder = 'border-warning';
            }

            let actionButtons = '';
            if (w.status === 'pending') {
                actionButtons = `
                    <div class="mt-3 pt-3 border-top border-light d-flex gap-2">
                        <button class="btn btn-success btn-sm flex-grow-1 shadow-sm" onclick="updateWithdrawStatus(${w.id}, 'success')">
                            <i class="bi bi-check-lg"></i> Setujui
                        </button>
                        <button class="btn btn-outline-danger btn-sm flex-grow-1" onclick="updateWithdrawStatus(${w.id}, 'failed')">
                            <i class="bi bi-x-lg"></i> Tolak
                        </button>
                    </div>
                `;
            }

            const date = new Date(w.created_at).toLocaleString('id-ID', { 
                day: 'numeric', month: 'short', year: 'numeric', 
                hour: '2-digit', minute: '2-digit' 
            });

            const itemHtml = `
                <div class="member-list-item ${w.status === 'pending' ? 'border-start border-5 ' + cardBorder : ''}">
                    <div class="d-flex justify-content-between align-items-start mb-2">
                        <div>
                            <div class="fw-bold text-dark">${w.username}</div>
                            <small class="text-muted">ID #${w.id}  ${date}</small>
                        </div>
                        ${statusBadge}
                    </div>
                    
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <span class="text-muted small">Nominal:</span>
                        <span class="fw-bold fs-5 text-dark">${formatRupiah(w.amount)}</span>
                    </div>

                    <div class="bg-light p-2 rounded small text-secondary mb-1">
                        <div class="fw-bold text-dark"><i class="bi bi-bank me-1"></i> ${w.bank_name.toUpperCase()}</div>
                        <div>${w.account_number}</div>
                        <div>a.n ${w.account_name}</div>
                    </div>
                    
                    <div class="small text-muted mb-1">
                        <i class="bi bi-whatsapp text-success me-1"></i> <a href="https://wa.me/${w.whatsapp}" target="_blank" class="text-decoration-none text-muted">${w.whatsapp}</a>
                    </div>

                    ${actionButtons}
                </div>
            `;
            listContainer.innerHTML += itemHtml;
        });
    }

    function loadAdminData() {
        // Init Filters First
        setupAdminFilters();

        fetch('/api/admin/users')
            .then(res => res.json())
            .then(users => {
                allUsersData = users; // Store global
                
                // Calculate Stats
                let connectedCount = 0;
                let disconnectedCount = 0;
                users.forEach(u => {
                    if (u.status === 'connected') connectedCount++; else disconnectedCount++;
                });
                document.getElementById('countConnected').innerText = connectedCount;
                document.getElementById('countDisconnected').innerText = disconnectedCount;

                // Initial Render
                renderMemberList(users);
            });

        fetch('/api/admin/withdrawals')
            .then(res => res.json())
            .then(withdrawals => {
                allWithdrawalsData = withdrawals; // Store global
                renderWithdrawalList(withdrawals);
            });
    }

    function updateWithdrawStatus(id, status) {
        Swal.fire({
            title: `Ubah Status ke ${status.toUpperCase()}?`,
            text: "Pastikan Anda sudah mengecek mutasi bank!",
            icon: status === 'success' ? 'question' : 'warning',
            showCancelButton: true,
            confirmButtonColor: status === 'success' ? '#198754' : '#dc3545',
            confirmButtonText: 'Ya, Ubah!',
            cancelButtonText: 'Batal'
        }).then((result) => {
            if (result.isConfirmed) {
                Swal.fire({ title: 'Memproses...', didOpen: () => Swal.showLoading() });
                
                fetch('/api/admin/withdrawals/update', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ id, status })
                })
                .then(res => res.json())
                .then(data => {
                    if (data.status === 'success') {
                        Swal.fire('Berhasil', 'Status berhasil diperbarui', 'success');
                        loadAdminData();
                    } else {
                        Swal.fire('Gagal', data.message, 'error');
                    }
                })
                .catch(err => Swal.fire('Error', 'Gagal menghubungi server', 'error'));
            }
        });
    }

    function addBalance(userId, username) {
        Swal.fire({
            title: `Tambah Saldo: ${username}`,
            input: 'number',
            inputLabel: 'Masukkan Jumlah Saldo',
            inputPlaceholder: 'Contoh: 50000',
            showCancelButton: true,
            confirmButtonText: 'Tambah',
            cancelButtonText: 'Batal',
            inputValidator: (value) => {
                if (!value || value <= 0) {
                    return 'Jumlah harus lebih dari 0!';
                }
            }
        }).then((result) => {
            if (result.isConfirmed) {
                const amount = result.value;
                
                Swal.fire({
                    title: 'Memproses...',
                    didOpen: () => Swal.showLoading()
                });

                fetch('/api/admin/add-balance', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ userId, amount })
                })
                .then(res => res.json())
                .then(data => {
                    if (data.status === 'success') {
                        Swal.fire('Berhasil!', data.message, 'success');
                        loadAdminData(); // Refresh table
                    } else {
                        Swal.fire('Gagal', data.message, 'error');
                    }
                })
                .catch(err => Swal.fire('Error', 'Gagal menghubungi server', 'error'));
            }
        });
    }

    function showMemberStatus(userId, username, status, pushname, wid) {
        let htmlContent = '';
        if (status === 'connected') {
            htmlContent = `
                <div class="text-center">
                    <div class="mb-3 text-success">
                        <i class="bi bi-check-circle-fill" style="font-size: 3rem;"></i>
                    </div>
                    <h5>Terhubung</h5>
                    <p class="mb-1"><strong>Nama WA:</strong> ${pushname}</p>
                    <p class="mb-0"><strong>Nomor:</strong> ${wid}</p>
                </div>
            `;
        } else {
            htmlContent = `
                <div class="text-center">
                    <div class="mb-3 text-danger">
                        <i class="bi bi-x-circle-fill" style="font-size: 3rem;"></i>
                    </div>
                    <h5>Terputus / Belum Terhubung</h5>
                    <p class="text-muted">User ini belum melakukan scan QR Code.</p>
                </div>
            `;
        }

        Swal.fire({
            title: `Status WA: ${username}`,
            html: htmlContent,
            showCloseButton: true,
            showConfirmButton: false
        });
    }

    function resetUserPassword(userId, username) {
        Swal.fire({
            title: `Reset Password: ${username}`,
            input: 'text',
            inputLabel: 'Masukkan Password Baru',
            inputPlaceholder: 'Minimal 6 karakter',
            showCancelButton: true,
            confirmButtonText: 'Reset Password',
            cancelButtonText: 'Batal',
            inputValidator: (value) => {
                if (!value || value.length < 6) {
                    return 'Password minimal 6 karakter!';
                }
            }
        }).then((result) => {
            if (result.isConfirmed) {
                Swal.fire({ title: 'Memproses...', didOpen: () => Swal.showLoading() });

                fetch('/api/admin/users/reset-password', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ userId, newPassword: result.value })
                })
                .then(res => res.json())
                .then(data => {
                    if (data.status === 'success') {
                        Swal.fire('Berhasil!', data.message, 'success');
                    } else {
                        Swal.fire('Gagal', data.message, 'error');
                    }
                })
                .catch(err => Swal.fire('Error', 'Gagal menghubungi server', 'error'));
            }
        });
    }

    function restartMemberDevice(userId, username) {
        Swal.fire({
            title: `Restart Sesi ${username}?`,
            text: "Koneksi WhatsApp member ini akan diputus paksa dan di-reset.",
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#d33',
            cancelButtonColor: '#3085d6',
            confirmButtonText: 'Ya, Restart!'
        }).then((result) => {
            if (result.isConfirmed) {
                Swal.fire({
                    title: 'Memproses...',
                    didOpen: () => Swal.showLoading()
                });

                fetch('/api/admin/device/restart', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ targetUserId: userId })
                })
                .then(res => res.json())
                .then(data => {
                    if (data.status === 'success') {
                        Swal.fire('Berhasil!', data.message, 'success');
                        loadAdminData(); // Refresh list status
                    } else {
                        Swal.fire('Gagal', data.message, 'error');
                    }
                })
                .catch(err => Swal.fire('Error', 'Gagal menghubungi server', 'error'));
            }
        });
    }

    function restartAllDevices() {
        Swal.fire({
            title: ' RESTART SEMUA KONEKSI?',
            text: "Tindakan ini akan memutus dan me-restart koneksi WhatsApp SELURUH MEMBER. Proses ini mungkin memakan waktu.",
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#d33',
            cancelButtonColor: '#3085d6',
            confirmButtonText: 'Ya, Restart SEMUA!',
            cancelButtonText: 'Batal'
        }).then((result) => {
            if (result.isConfirmed) {
                Swal.fire({
                    title: 'Memproses Masal...',
                    text: 'Mohon tunggu, jangan tutup halaman ini.',
                    allowOutsideClick: false,
                    didOpen: () => Swal.showLoading()
                });

                fetch('/api/admin/device/restart', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ targetUserId: 'all' })
                })
                .then(res => res.json())
                .then(data => {
                    if (data.status === 'success') {
                        Swal.fire('Selesai!', data.message, 'success');
                        loadAdminData();
                    } else {
                        Swal.fire('Gagal', data.message, 'error');
                    }
                })
                .catch(err => Swal.fire('Error', 'Gagal menghubungi server', 'error'));
            }
        });
    }

    // Handle Withdraw Form
    document.getElementById('withdrawForm').addEventListener('submit', function(e) {
        e.preventDefault();
        
        const data = {
            amount: document.getElementById('wdAmount').value,
            bank_name: document.getElementById('wdBank').value,
            account_number: document.getElementById('wdRek').value,
            account_name: document.getElementById('wdName').value,
            whatsapp: document.getElementById('wdWa').value
        };

        Swal.fire({
            title: 'Konfirmasi Penarikan',
            text: `Yakin ingin menarik ${formatRupiah(data.amount)}?`,
            icon: 'question',
            showCancelButton: true,
            confirmButtonText: 'Ya, Tarik!',
            cancelButtonText: 'Batal'
        }).then((result) => {
            if (result.isConfirmed) {
                Swal.fire({
                    title: 'Memproses...',
                    didOpen: () => Swal.showLoading()
                });

                fetch('/api/withdraw', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                })
                .then(res => res.json())
                .then(res => {
                    if(res.status === 'success') {
                        Swal.fire('Berhasil!', 'Permintaan penarikan telah dikirim.', 'success');
                        bootstrap.Modal.getInstance(document.getElementById('withdrawModal')).hide();
                        initUser(); 
                    } else {
                        Swal.fire('Gagal!', res.message, 'error');
                    }
                })
                .catch(err => Swal.fire('Error!', 'Terjadi kesalahan koneksi', 'error'));
            }
        });
    });

    // Handle Change Password Form
    document.getElementById('changePasswordForm').addEventListener('submit', function(e) {
        e.preventDefault();
        
        const oldPassword = document.getElementById('oldPassword').value;
        const newPassword = document.getElementById('newPassword').value;
        const confirmPassword = document.getElementById('confirmPassword').value;

        if (newPassword !== confirmPassword) {
            Swal.fire('Error', 'Password baru tidak sama!', 'error');
            return;
        }

        Swal.fire({
            title: 'Memproses...',
            didOpen: () => Swal.showLoading()
        });

        fetch('/api/change-password', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ oldPassword, newPassword })
        })
        .then(res => res.json())
        .then(data => {
            if (data.status === 'success') {
                Swal.fire('Berhasil', data.message, 'success');
                document.getElementById('changePasswordForm').reset();
                bootstrap.Modal.getInstance(document.getElementById('changePasswordModal')).hide();
            } else {
                Swal.fire('Gagal', data.message, 'error');
            }
        })
        .catch(err => Swal.fire('Error', 'Gagal menghubungi server', 'error'));
    });

    function addLog(msg) {
        const div = document.createElement('div');
        div.className = 'log-entry';
        const time = new Date().toLocaleTimeString();
        div.innerHTML = `<span class="log-time">[${time}]</span> ${msg}`;
        logsDiv.appendChild(div);
        logsDiv.scrollTop = logsDiv.scrollHeight;

        if (msg.includes('Komisi +Rp')) {
            initUser();
        }
    }

    socket.on('message', (msg) => {
        addLog(msg);
    });

    socket.on('qr', (src) => {
        updateStatusUI('waiting_qr', null);
        qrDiv.innerHTML = `<img src="${src}" alt="QR Code" class="img-fluid border p-2 bg-white rounded shadow-sm">`;
        addLog('QR Code diterima, silahkan scan.');
    });

    socket.on('ready', (msg) => {
        updateStatusUI('connected', { pushname: 'WhatsApp', wid: { user: 'Connected' } });
        addLog('WhatsApp siap digunakan!');
    });

    socket.on('authenticated', (msg) => {
        addLog('WhatsApp terautentikasi!');
    });

    document.getElementById('blastForm').addEventListener('submit', function(e) {
        e.preventDefault();
        
        const numbers = document.getElementById('numbers').value;
        const message = document.getElementById('message').value;
        const senderId = document.getElementById('senderId').value;

        if(!numbers || !message) {
            Swal.fire('Perhatian', 'Nomor dan pesan tidak boleh kosong!', 'warning');
            return;
        }

        let confirmMsg = `Yakin ingin mengirim pesan ke ${numbers.split('\n').filter(n=>n.trim()).length} nomor?`;
        if (senderId) {
            confirmMsg += `\n\n PERHATIAN: Anda mengirim menggunakan sesi Member ID: ${senderId}`;
        }

        Swal.fire({
            title: 'Konfirmasi Kirim',
            text: confirmMsg,
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#3085d6',
            cancelButtonColor: '#d33',
            confirmButtonText: 'Ya, Kirim!'
        }).then((result) => {
            if (result.isConfirmed) {
                addLog(' Mengirim permintaan ke server...');
                
                fetch('/send-message', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ numbers, message, senderId }),
                })
                .then(response => response.json())
                .then(data => {
                    if(data.status === 'error') {
                         addLog(` Error: ${data.message}`);
                         Swal.fire('Gagal', data.message, 'error');
                    } else {
                        Swal.fire('Terkirim!', 'Proses blast telah dimulai.', 'success');
                    }
                })
                .catch((error) => {
                    console.error('Error:', error);
                    addLog(' Error koneksi ke server.');
                    Swal.fire('Error', 'Gagal terhubung ke server', 'error');
                });
            }
        });
    });
</script>

</body>
</html>