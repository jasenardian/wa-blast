<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Dashboard - WA Blast Pro</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
    <style>
        :root {
            /* Dark Theme Palette */
            --bg-body: #000000;
            --bg-card: #0d111b;
            --bg-nav: #0d111b;
            --text-primary: #f8fafc;
            --text-secondary: #94a3b8;
            --accent-green: #10b981;
            --accent-red: #ef4444;
            --accent-blue: #3b82f6;
            --accent-yellow: #f59e0b;
            --accent-purple: #8b5cf6;
            --sidebar-width: 280px;
        }

        body {
            background-color: var(--bg-body);
            color: var(--text-primary);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            overflow-x: hidden;
            padding-bottom: 80px; /* Space for bottom nav on mobile */
        }

        /* --- Layout & Typography --- */
        h1, h2, h3, h4, h5, h6 { color: white; font-weight: 700; }
        .text-muted { color: var(--text-secondary) !important; }
        
        /* --- Sidebar (Desktop Only) --- */
        @media (min-width: 768px) {
            body { padding-bottom: 0; }
            #wrapper { display: flex; width: 100%; }
            #sidebar-wrapper {
                width: var(--sidebar-width);
                background: var(--bg-card);
                min-height: 100vh;
                border-right: 1px solid rgba(255,255,255,0.05);
                position: fixed;
                top: 0; left: 0; z-index: 1000;
            }
            #page-content-wrapper {
                margin-left: var(--sidebar-width);
                width: calc(100% - var(--sidebar-width));
                padding: 20px;
            }
            .bottom-nav { display: none !important; }
        }

        @media (max-width: 767.98px) {
            #sidebar-wrapper { display: none; }
            #page-content-wrapper { width: 100%; padding: 15px; }
            .navbar-custom { display: none; } /* Hide top navbar on mobile if we use app bar */
        }

        /* --- Components --- */
        .card {
            background-color: var(--bg-card);
            border: 1px solid rgba(255,255,255,0.05);
            border-radius: 16px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }

        /* Top App Bar (Mobile) */
        .app-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 0;
            margin-bottom: 20px;
        }
        .app-bar-brand {
            font-size: 1.25rem;
            font-weight: 800;
            color: white;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .app-bar-brand .dot {
            width: 8px; height: 8px; background: var(--accent-green); border-radius: 50%;
        }
        .user-pill {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .logout-btn {
            background: rgba(239, 68, 68, 0.15);
            color: var(--accent-red);
            border: none;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        .user-avatar {
            width: 36px; height: 36px;
            background: var(--accent-purple);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 1rem;
        }
        .user-status {
            text-align: right;
            font-size: 0.75rem;
            color: var(--text-secondary);
            margin-top: -5px;
        }
        .status-online { color: var(--accent-green); }

        /* Greeting Card */
        .greeting-card {
            background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 16px;
            padding: 20px;
            position: relative;
            margin-bottom: 20px;
            overflow: hidden;
        }
        .greeting-icon { font-size: 2rem; margin-right: 10px; }
        .confetti-icon { position: absolute; right: 20px; top: 20px; font-size: 2.5rem; }

        /* Stats Grid */
        .stats-tile {
            background: var(--bg-card);
            border-radius: 12px;
            padding: 15px 10px;
            text-align: center;
            border: 1px solid rgba(255,255,255,0.05);
            height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        .stats-icon-circle {
            width: 32px; height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 8px;
            border: 2px solid currentColor;
            font-size: 0.9rem;
        }
        .stats-value { font-size: 1.25rem; font-weight: 800; margin-bottom: 2px; }
        .stats-label { font-size: 0.65rem; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 0.5px; font-weight: 600; }
        
        .tile-active .stats-icon-circle { color: var(--accent-green); border-color: var(--accent-green); }
        .tile-active .stats-value { color: var(--accent-green); }
        
        .tile-offline .stats-icon-circle { color: var(--accent-red); border-color: var(--accent-red); }
        .tile-offline .stats-value { color: var(--accent-red); }
        
        .tile-blast .stats-icon-circle { color: var(--accent-blue); border-color: var(--accent-blue); }
        .tile-blast .stats-value { color: var(--accent-blue); }
        
        .tile-earn .stats-icon-circle { color: var(--accent-yellow); border-color: var(--accent-yellow); }
        .tile-earn .stats-value { color: var(--accent-yellow); }

        /* Balance Card */
        .balance-card {
            background: #1e293b;
            border-radius: 16px;
            padding: 20px;
            position: relative;
            margin-bottom: 25px;
            overflow: hidden;
            border: 1px solid rgba(255,255,255,0.05);
        }
        .balance-card::before {
            content: '';
            position: absolute;
            bottom: 0; left: 0; right: 0;
            height: 60px;
            background: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 1440 320'%3E%3Cpath fill='%233b82f6' fill-opacity='0.1' d='M0,192L48,197.3C96,203,192,213,288,229.3C384,245,480,267,576,250.7C672,235,768,181,864,181.3C960,181,1056,235,1152,234.7C1248,235,1344,181,1392,154.7L1440,128L1440,320L1392,320C1344,320,1248,320,1152,320C1056,320,960,320,864,320C768,320,672,320,576,320C480,320,384,320,288,320C192,320,96,320,48,320L0,320Z'%3E%3C/path%3E%3C/svg%3E");
            background-size: cover;
            background-position: bottom;
            opacity: 0.5;
        }
        .balance-title { font-size: 0.75rem; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 1px; }
        .balance-amount { font-size: 2rem; font-weight: 800; color: white; margin: 5px 0 20px 0; }
        .balance-actions { display: flex; gap: 10px; position: relative; z-index: 2; }
        .btn-balance {
            flex: 1;
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.1);
            color: white;
            padding: 10px;
            border-radius: 12px;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: all 0.2s;
        }
        .btn-balance:hover { background: rgba(255,255,255,0.1); color: white; }
        .card-icon-top { position: absolute; top: 20px; right: 20px; font-size: 1.5rem; color: var(--accent-green); }

        /* Quick Links */
        .quick-link-card {
            background: var(--bg-card);
            border-radius: 12px;
            padding: 20px 10px;
            text-align: center;
            border: 1px solid rgba(255,255,255,0.05);
            transition: transform 0.2s;
            cursor: pointer;
        }
        .quick-link-card:active { transform: scale(0.98); }
        .quick-link-icon { font-size: 1.5rem; margin-bottom: 10px; }
        .quick-link-label { font-size: 0.85rem; color: white; font-weight: 500; }
        
        /* Info Cards */
        .info-card {
            background: var(--bg-card);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 15px;
            border: 1px solid rgba(255,255,255,0.05);
        }
        .info-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .info-title { font-size: 1rem; font-weight: 700; color: white; margin: 0; }
        .info-row { display: flex; justify-content: space-between; margin-bottom: 8px; }
        .info-label { color: var(--text-secondary); font-size: 0.9rem; }
        .info-value { font-weight: 600; color: white; font-size: 0.95rem; }

        /* Floating Button */
        .fab {
            position: fixed;
            bottom: 90px;
            right: 20px;
            width: 50px;
            height: 50px;
            background: linear-gradient(135deg, #10b981, #059669);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.5rem;
            box-shadow: 0 4px 15px rgba(16, 185, 129, 0.4);
            z-index: 990;
            text-decoration: none;
        }

        /* Bottom Navigation */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            background: var(--bg-nav);
            border-top: 1px solid rgba(255,255,255,0.05);
            padding: 10px 15px;
            display: flex;
            justify-content: space-around;
            z-index: 1000;
        }
        .nav-item-mobile {
            text-align: center;
            color: var(--text-secondary);
            text-decoration: none;
            font-size: 0.7rem;
            flex: 1;
        }
        .nav-item-mobile i {
            display: block;
            font-size: 1.4rem;
            margin-bottom: 4px;
        }
        .nav-item-mobile.active { color: var(--accent-green); }

        /* Sidebar Links (Desktop) */
        .sidebar-link {
            color: var(--text-secondary);
            padding: 12px 20px;
            display: flex;
            align-items: center;
            gap: 12px;
            text-decoration: none;
            transition: all 0.2s;
            border-left: 3px solid transparent;
        }
        .sidebar-link:hover { background: rgba(255,255,255,0.05); color: white; }
        .sidebar-link.active { background: rgba(16, 185, 129, 0.1); color: var(--accent-green); border-left-color: var(--accent-green); }

        /* Admin Styles Adaptation */
        .admin-stat-card { background: var(--bg-card); border: 1px solid rgba(255,255,255,0.05); }
        .admin-stat-card.success { color: var(--accent-green); }
        .admin-stat-card.danger { color: var(--accent-red); }
        .member-list-item { background: var(--bg-card); border: 1px solid rgba(255,255,255,0.05); }
        .member-name { color: white; }

        /* Utilities */
        .text-accent-purple { color: var(--accent-purple); }
        .text-accent-yellow { color: var(--accent-yellow); }
    </style>
</head>
<body>

    <!-- Desktop Sidebar -->
    <div id="sidebar-wrapper">
        <div class="p-4 border-bottom border-secondary border-opacity-25">
            <h4 class="m-0"><i class="bi bi-whatsapp text-success"></i> WA Blast Pro</h4>
            <!-- Riwayat Blast (Khusus Pro/Admin) -->
            <div id="blastHistorySection" class="mt-4" style="display:none;">
                <div class="card bg-dark border border-secondary border-opacity-25 p-3">
                    <div class="d-flex align-items-center mb-3">
                        <div class="bg-info bg-opacity-10 rounded p-2 me-3">
                            <i class="bi bi-broadcast fs-4 text-info"></i>
                        </div>
                        <div>
                            <h5 class="mb-0">Riwayat Blast</h5>
                            <div class="small text-muted">Log pengiriman pesan Anda</div>
                        </div>
                    </div>
                    
                    <div id="blastHistoryContainer" class="small">
                        <div class="text-center py-4 text-secondary">Memuat riwayat...</div>
                    </div>
                </div>
            </div>

        </div>
        <div class="py-3">
            <a href="#" class="sidebar-link active" onclick="showSection('dashboard', this); setActiveNav('home')">
                <i class="bi bi-grid-fill"></i> Dashboard
            </a>
            <a href="#" class="sidebar-link" onclick="showSection('whatsapp', this); showAddDeviceModal(); setActiveNav('wa')">
                <i class="bi bi-whatsapp"></i> WhatsApp
            </a>
            <a href="#" class="sidebar-link" onclick="showSection('referral', this); setActiveNav('ref')">
                <i class="bi bi-people-fill"></i> Referral
            </a>
            <a href="#" class="sidebar-link" onclick="showSection('withdraw', this); setActiveNav('wd')">
                <i class="bi bi-wallet-fill"></i> Dompet
            </a>
            <a href="#" class="sidebar-link" onclick="showSection('profile', this); setActiveNav('profile')">
                <i class="bi bi-person-fill"></i> Profil Saya
            </a>
            
            <div class="mt-4 px-3 text-uppercase text-muted small fw-bold">Admin</div>
            <a href="#" id="desktop-nav-admin" class="sidebar-link" style="display:none;" onclick="showSection('admin', this)">
                <i class="bi bi-shield-lock"></i> Admin Panel
            </a>
            <a href="/riwayat_blast.html" id="desktop-nav-history" class="sidebar-link" style="display:none;">
                <i class="bi bi-broadcast"></i> Riwayat Blast
            </a>

            <div class="mt-auto border-top border-secondary border-opacity-25 pt-3">
                <a href="#" onclick="doLogout()" class="sidebar-link text-danger">
                    <i class="bi bi-box-arrow-right"></i> Logout
                </a>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div id="page-content-wrapper">
        
        <!-- App Bar (Visible on Mobile/Tablet) -->
        <div class="app-bar">
            <div class="d-block">
                <div class="app-bar-brand">
                    WA Blast Pro <span class="dot"></span>
                </div>
                <div class="small text-muted">Dashboard</div>
            </div>
            <div class="d-flex align-items-center gap-2">
                <button onclick="doLogout()" class="logout-btn">
                    <i class="bi bi-box-arrow-right"></i> Keluar
                </button>
                <div class="user-avatar" id="headerAvatar">U</div>
            </div>
        </div>
        <div class="user-status mb-3">
            <span id="headerUsername">User</span> â€¢ <span class="status-online">Online</span>
        </div>

        <!-- Section: Dashboard -->
        <div id="section-dashboard">
            
            <!-- Greeting -->
            <div class="greeting-card">
                <div class="d-flex align-items-center">
                    <div class="greeting-icon">ðŸŽº</div>
                    <div>
                        <h4 class="mb-1">Halo, <span id="greetUsername">User</span>!</h4>
                        <div class="small text-secondary">Selamat datang </div>
                    </div>
                </div>
                <div class="confetti-icon">ðŸŽ‰</div>
            </div>

            <!-- Stats Grid -->
            <div class="row g-2 mb-4">
                <div class="col-3">
                    <div class="stats-tile tile-active">
                        <div class="stats-icon-circle"><i class="bi bi-check-lg"></i></div>
                        <div class="stats-value" id="dashStatActive">0</div>
                        <div class="stats-label">AKTIF</div>
                    </div>
                </div>
                <div class="col-3">
                    <div class="stats-tile tile-offline">
                        <div class="stats-icon-circle"><i class="bi bi-x-lg"></i></div>
                        <div class="stats-value" id="dashStatOffline">0</div>
                        <div class="stats-label">OFFLINE</div>
                    </div>
                </div>
                <div class="col-3">
                    <div class="stats-tile tile-blast">
                        <div class="stats-icon-circle"><i class="bi bi-send"></i></div>
                        <div class="stats-value" id="dashStatBlast">0</div>
                        <div class="stats-label">BLAST</div>
                    </div>
                </div>
                <div class="col-3">
                    <div class="stats-tile tile-earn">
                        <div class="stats-icon-circle"><i class="bi bi-currency-dollar"></i></div>
                        <div class="stats-value" style="font-size: 0.9rem;" id="dashStatEarn">0</div>
                        <div class="stats-label">EARNING</div>
                    </div>
                </div>
            </div>

            <!-- Balance Card -->
            <div class="balance-card">
                <div class="card-icon-top"><i class="bi bi-credit-card"></i></div>
                <div class="balance-title">TOTAL BALANCE</div>
                <div class="balance-amount" id="dashBalance">Rp0</div>
                <div class="balance-actions">
                    <button class="btn-balance" onclick="showSection('withdraw'); setActiveNav('wd')">
                        <i class="bi bi-wallet2"></i> Dompet
                    </button>
                    <button class="btn-balance" onclick="showAddDeviceModal()">
                        <i class="bi bi-plus-lg"></i> Tambah
                    </button>
                </div>
            </div>

            <!-- Quick Links -->
            <h5 class="mb-3">Quick Link</h5>
            <div class="row g-2 mb-4">
                <div class="col-4">
                    <div class="quick-link-card" onclick="showAddDeviceModal()">
                        <div class="quick-link-icon text-success"><i class="bi bi-whatsapp"></i></div>
                        <div class="quick-link-label">WhatsApp</div>
                    </div>
                </div>
                <div class="col-4">
                    <div class="quick-link-card" onclick="showSection('referral'); setActiveNav('ref')">
                        <div class="quick-link-icon text-accent-purple"><i class="bi bi-people-fill"></i></div>
                        <div class="quick-link-label">Referral</div>
                    </div>
                </div>
                <div class="col-4">
                    <div class="quick-link-card" onclick="showSection('profile'); setActiveNav('profile')">
                        <div class="quick-link-icon text-info"><i class="bi bi-person-fill"></i></div>
                        <div class="quick-link-label">Profil</div>
                    </div>
                </div>
            </div>

            <!-- Informasi Section -->
            <h5 class="mb-3">Informasi</h5>
            
            <!-- Program Referral -->
            <div class="info-card position-relative">
                <i class="bi bi-bullseye position-absolute top-0 end-0 m-3 text-accent-purple fs-4"></i>
                <div class="info-title mb-3">Program Referral</div>
                <div class="row">
                    <div class="col-6">
                        <div class="info-label">Total Referral</div>
                        <div class="info-value text-accent-purple fs-5" id="dashRefTotal">0</div>
                    </div>
                    <div class="col-6">
                        <div class="info-label">Rate Komisi</div>
                        <div class="info-value text-accent-yellow fs-5">Rp60</div>
                    </div>
                </div>
            </div>

            <!-- Tarif & Ketentuan -->
            <div class="info-card position-relative">
                <i class="bi bi-file-text position-absolute top-0 end-0 m-3 text-white fs-4"></i>
                <div class="info-title mb-3">Tarif & Ketentuan</div>
                <div class="info-row">
                    <span class="info-label">Rate per pesan:</span>
                    <span class="info-value">Rp550</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Min. withdraw:</span>
                    <span class="info-value">Rp10.000</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Member sejak:</span>
                    <span class="info-value" id="memberSince">...</span>
                </div>
            </div>
            
            <!-- Device List (Hidden by default, shown via modal or separate section usually, but let's keep it accessible) -->
             <div class="info-card">
                 <div class="info-header">
                     <div class="info-title">Perangkat Saya</div>
                     <button class="btn btn-sm btn-outline-light rounded-pill" onclick="showAddDeviceModal()">Tambah</button>
                 </div>
                 <div id="devicesListContainer" class="text-secondary small">
                     Loading...
                 </div>
             </div>

        </div>

        <!-- Section: Withdraw -->
        <div id="section-withdraw" style="display: none;">
            
            <!-- Main Balance Card -->
            <div class="card mb-3 p-3 bg-opacity-25 bg-dark">
                <div class="d-flex justify-content-between align-items-start mb-2">
                    <div class="d-flex align-items-center">
                        <i class="bi bi-credit-card-2-front fs-2 text-info me-3"></i>
                        <div>
                            <div class="small text-secondary fw-bold">SALDO TERSEDIA</div>
                            <div class="small text-success">Min: Rp10.000</div>
                        </div>
                    </div>
                    <span class="badge rounded-pill bg-success bg-opacity-25 text-success px-3 py-2">READY</span>
                </div>

                <div class="fs-1 fw-bold text-success mb-3" id="wdBalanceDisplay">Rp 0</div>

                <div class="mb-3">
                    <div class="d-flex justify-content-between small mb-1">
                        <span class="text-secondary">Progress ke minimum:</span>
                        <span class="text-success" id="wdProgressText">0%</span>
                    </div>
                    <div class="progress" style="height: 8px; background-color: rgba(255,255,255,0.1);">
                        <div class="progress-bar bg-success" role="progressbar" style="width: 0%" id="wdProgressBar"></div>
                    </div>
                </div>

                <div class="d-flex align-items-center small text-warning" id="wdWarningText">
                    <i class="bi bi-exclamation-triangle me-2"></i>
                    <span>Kurang Rp10.000 lagi</span>
                </div>
                
                <div class="mt-3">
                    <button class="btn btn-primary w-100 rounded-pill fw-bold" onclick="showTopupModal()">
                        <i class="bi bi-plus-circle me-2"></i> Isi Saldo (Top Up)
                    </button>
                </div>
            </div>

            <!-- Tab Nav for Wallet -->
            <ul class="nav nav-pills nav-fill mb-3 bg-dark rounded p-1 border border-secondary border-opacity-25" id="walletTabs" role="tablist">
                <li class="nav-item">
                    <button class="nav-link active text-white small" data-bs-toggle="pill" data-bs-target="#tabWithdraw">Penarikan</button>
                </li>
                <li class="nav-item">
                    <button class="nav-link text-white small" data-bs-toggle="pill" data-bs-target="#tabTopupHistory">Riwayat Topup</button>
                </li>
            </ul>

            <div class="tab-content">
                <!-- Tab Penarikan -->
                <div class="tab-pane fade show active" id="tabWithdraw">
                    <!-- Section: Request Withdraw -->
                    <div class="card mb-3 p-3">
                        <div class="d-flex align-items-start mb-3">
                            <div class="bg-success bg-opacity-10 rounded p-2 me-3">
                                <i class="bi bi-cash-stack fs-4 text-success"></i>
                            </div>
                            <div>
                                <h5 class="mb-0">Request Withdraw</h5>
                                <div class="small text-muted">Tarik saldo ke rekening</div>
                            </div>
                        </div>

                        <!-- Warning Panel (If Bank Not Set) - Toggle Visibility based on logic -->
                        <div id="wdBankWarning" class="text-center py-4">
                             <div class="bg-warning bg-opacity-10 rounded-circle d-inline-flex p-3 mb-3">
                                 <i class="bi bi-exclamation-triangle-fill fs-3 text-warning"></i>
                             </div>
                             <h6 class="text-white">Data Bank Belum Diatur</h6>
                             <p class="small text-muted mb-3">Atur informasi bank terlebih dahulu</p>
                             <button class="btn btn-info text-white btn-sm px-4 rounded-pill" onclick="showSection('profile'); setActiveNav('profile')">
                                 <i class="bi bi-gear-fill me-2"></i> Pengaturan Profil
                             </button>
                        </div>

                        <!-- Actual Form (Hidden if Warning Shown) -->
                        <form id="wdRequestForm" style="display:none;">
                             <div class="alert alert-info small border-0 bg-opacity-10 bg-info text-info mb-3">
                                 <i class="bi bi-info-circle me-1"></i> Saldo akan dikirim ke rekening yang terdaftar di Profil.
                             </div>
                             <div class="mb-3">
                                <label class="small text-muted mb-1">Jumlah Penarikan</label>
                                <div class="input-group">
                                    <span class="input-group-text bg-dark border-secondary text-secondary">Rp</span>
                                    <input type="number" class="form-control bg-dark text-white border-secondary" id="wdRequestAmount" min="10000" placeholder="0">
                                </div>
                             </div>
                             <button type="submit" class="btn btn-success w-100">
                                 <i class="bi bi-send me-2"></i> Kirim Permintaan
                             </button>
                        </form>
                    </div>

                    <!-- Section: Riwayat Withdraw -->
                    <div class="card mb-3 p-3">
                        <div class="d-flex align-items-start mb-3">
                            <div class="bg-secondary bg-opacity-10 rounded p-2 me-3">
                                <i class="bi bi-clipboard-data fs-4 text-warning"></i>
                            </div>
                            <div>
                                <h5 class="mb-0">Riwayat Withdraw</h5>
                                <div class="small text-muted">10 transaksi terakhir</div>
                            </div>
                        </div>
                        
                        <div id="wdHistoryContainer" class="text-center py-5">
                            <div class="position-relative d-inline-block mb-3 opacity-50">
                                <i class="bi bi-file-earmark-text fs-1 text-warning"></i>
                                <div class="position-absolute bottom-0 end-0 bg-dark rounded-circle p-1">
                                     <div class="spinner-border spinner-border-sm text-secondary" style="width: 1rem; height: 1rem;"></div>
                                </div>
                            </div>
                            <h6 class="text-white">Belum Ada Riwayat</h6>
                            <div class="small text-muted">Riwayat withdraw akan muncul di sini</div>
                        </div>
                    </div>
                </div>

                <!-- Tab Riwayat Topup -->
                <div class="tab-pane fade" id="tabTopupHistory">
                     <div class="card mb-3 p-3">
                        <div class="d-flex align-items-start mb-3">
                            <div class="bg-primary bg-opacity-10 rounded p-2 me-3">
                                <i class="bi bi-clock-history fs-4 text-primary"></i>
                            </div>
                            <div>
                                <h5 class="mb-0">Riwayat Top Up</h5>
                                <div class="small text-muted">Status permintaan isi saldo</div>
                            </div>
                        </div>
                        <div id="topupHistoryContainer" class="text-center py-5">
                            Loading...
                        </div>
                     </div>
                </div>
            </div>

        </div>

        <!-- Section: WhatsApp -->
        <div id="section-whatsapp" style="display: none;">
            
            <div class="mb-4">
                <h2 class="fw-bold mb-1">WhatsApp</h2>
                <div class="text-secondary small">Kelola WhatsApp Anda untuk menerima pesan</div>
            </div>

            <button class="btn btn-success w-100 py-3 rounded-4 mb-4 fw-bold shadow-sm" onclick="showAddDeviceModal()">
                <i class="bi bi-plus-lg me-2"></i> Tambah WhatsApp
            </button>

            <!-- Warning Card -->
            <div class="card mb-4 border-0 shadow-sm overflow-hidden" style="background: #f8fafc;">
                <div class="d-flex">
                    <div class="bg-danger" style="width: 6px;"></div>
                    <div class="p-3 w-100">
                        <div class="d-flex align-items-center mb-2">
                            <div class="bg-danger rounded-2 p-1 me-2 d-flex align-items-center justify-content-center" style="width: 24px; height: 24px;">
                                <i class="bi bi-exclamation-triangle-fill text-white" style="font-size: 12px;"></i>
                            </div>
                            <span class="badge bg-danger rounded-pill">PERINGATAN PENTING</span>
                        </div>
                        <div class="text-dark small mb-3" style="line-height: 1.6;">
                            Dilarang <span class="badge bg-danger rounded-pill fw-normal">menghapus pesan</span> yang sudah terkirim atau menggunakan <span class="badge bg-danger rounded-pill fw-normal">timer</span>.
                        </div>
                        <div class="badge bg-danger w-100 py-2 rounded-pill"><i class="bi bi-slash-circle me-1"></i> PEMBLOKIRAN AKUN PERMANEN</div>
                    </div>
                </div>
            </div>

            <!-- Stats Grid (WhatsApp Specific) -->
            <div class="row g-2 mb-4">
                <div class="col-3">
                    <div class="card bg-dark border border-secondary border-opacity-25 p-2 text-center h-100">
                        <div class="mx-auto mb-2 d-flex align-items-center justify-content-center bg-success rounded-1" style="width: 30px; height: 30px;">
                            <i class="bi bi-check-lg text-white"></i>
                        </div>
                        <div class="fs-4 fw-bold text-info" id="waStatActive">0</div>
                        <div class="small text-success fw-bold" style="font-size: 0.6rem;">AKTIF</div>
                    </div>
                </div>
                <div class="col-3">
                    <div class="card bg-dark border border-secondary border-opacity-25 p-2 text-center h-100">
                        <div class="mx-auto mb-2 d-flex align-items-center justify-content-center bg-danger rounded-1" style="width: 30px; height: 30px;">
                            <i class="bi bi-x-lg text-white"></i>
                        </div>
                        <div class="fs-4 fw-bold text-info" id="waStatOffline">0</div>
                        <div class="small text-danger fw-bold" style="font-size: 0.6rem;">OFFLINE</div>
                    </div>
                </div>
                <div class="col-3">
                    <div class="card bg-dark border border-secondary border-opacity-25 p-2 text-center h-100">
                        <div class="mx-auto mb-2 d-flex align-items-center justify-content-center bg-primary rounded-1" style="width: 30px; height: 30px;">
                            <i class="bi bi-phone text-white"></i>
                        </div>
                        <div class="fs-4 fw-bold text-info" id="waStatTotal">0</div>
                        <div class="small text-primary fw-bold" style="font-size: 0.6rem;">TOTAL</div>
                    </div>
                </div>
                <div class="col-3">
                    <div class="card bg-dark border border-secondary border-opacity-25 p-2 text-center h-100">
                        <div class="mx-auto mb-2 d-flex align-items-center justify-content-center bg-warning rounded-1" style="width: 30px; height: 30px;">
                            <i class="bi bi-chat-left-text-fill text-white" style="font-size: 0.8rem;"></i>
                        </div>
                        <div class="fs-4 fw-bold text-info" id="waStatMessages">0</div>
                        <div class="small text-warning fw-bold" style="font-size: 0.6rem;">PESAN</div>
                    </div>
                </div>
            </div>

            <!-- WhatsApp List Card -->
            <div class="card bg-dark border border-secondary border-opacity-25 p-3">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <div class="d-flex align-items-center">
                        <i class="bi bi-phone text-primary me-2 fs-5"></i>
                        <div>
                            <div class="fw-bold text-white d-flex align-items-center">
                                Daftar WhatsApp 
                                <span class="badge rounded-circle bg-secondary bg-opacity-25 ms-2 text-secondary" id="waListCount" style="width: 20px; height: 20px; display: flex; align-items: center; justify-content: center; font-size: 0.6rem;">0</span>
                            </div>
                            <div class="small text-secondary" style="font-size: 0.7rem;">WhatsApp terdaftar</div>
                        </div>
                    </div>
                </div>

                <div class="mb-3">
                     <select class="form-select bg-dark text-white border-secondary mb-2" id="blastSenderMode">
                         <option value="all">Semua Perangkat</option>
                         <option value="random">Acak (Random)</option>
                     </select>
                     <button class="btn btn-danger w-100 rounded-pill" onclick="showBlastModal()">
                         <i class="bi bi-lightning-fill me-1"></i> Blast All
                     </button>
                </div>

                <div id="whatsappListContainer" class="text-center py-5 border-top border-secondary border-opacity-25">
                    <div class="mb-3 opacity-25">
                        <i class="bi bi-phone fs-1 text-white"></i>
                    </div>
                    <h6 class="text-white mb-1">Belum ada WhatsApp</h6>
                    <div class="small text-secondary px-4">Klik "Tambah WhatsApp" untuk menambahkan nomor pertama Anda</div>
                </div>
            </div>

            <!-- Riwayat Blast (Khusus Pro/Admin) -->
            <div id="blastHistorySection" class="mt-4" style="display:none;">
                <div class="card bg-dark border border-secondary border-opacity-25 p-3">
                    <div class="d-flex align-items-center mb-3">
                        <div class="bg-info bg-opacity-10 rounded p-2 me-3">
                            <i class="bi bi-broadcast fs-4 text-info"></i>
                        </div>
                        <div>
                            <h5 class="mb-0">Riwayat Blast</h5>
                            <div class="small text-muted">Log pengiriman pesan Anda</div>
                        </div>
                    </div>
                    
                    <div id="blastHistoryContainer" class="small">
                        <div class="text-center py-4 text-secondary">Memuat riwayat...</div>
                    </div>
                </div>
            </div>

        </div>

        <!-- Section: Referral -->
        <div id="section-referral" style="display: none;">
            
            <!-- Stats Row -->
            <div class="row g-2 mb-3">
                <div class="col-6">
                    <div class="card p-3 h-100 bg-opacity-25 bg-primary border-primary border-opacity-25">
                        <div class="d-flex align-items-center">
                            <i class="bi bi-people-fill fs-2 text-primary me-3"></i>
                            <div>
                                <div class="fs-3 fw-bold text-info" id="refTotalStat">0</div>
                                <div class="small text-uppercase text-secondary" style="font-size: 0.65rem;">REFERRAL</div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-6">
                    <div class="card p-3 h-100 bg-opacity-25 bg-warning border-warning border-opacity-25">
                        <div class="d-flex align-items-center">
                            <i class="bi bi-coin fs-2 text-warning me-3"></i>
                            <div class="w-100">
                                <div class="fs-5 fw-bold text-warning" id="refCommissionStat">Rp0</div>
                                <div class="small text-uppercase text-secondary" style="font-size: 0.65rem;">KOMISI</div>
                                <div class="progress mt-1" style="height: 3px; background-color: rgba(255,255,255,0.1);">
                                    <div class="progress-bar bg-info" role="progressbar" style="width: 50%"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Link Referral -->
            <div class="card mb-3 p-3">
                <div class="small text-secondary mb-2 text-uppercase">LINK REFERRAL ANDA</div>
                <div class="d-flex gap-2 mb-3">
                    <div class="input-group">
                        <span class="input-group-text bg-dark border-secondary text-secondary"><i class="bi bi-link-45deg"></i></span>
                        <input type="text" class="form-control bg-dark text-white border-secondary" id="refLinkInput" readonly value="...">
                    </div>
                    <button class="btn btn-primary" onclick="copyRefLink()">
                        <i class="bi bi-clipboard-check"></i> Copy
                    </button>
                </div>
                
                <div class="alert alert-dark border border-secondary border-opacity-25 d-flex align-items-center p-2 mb-0">
                    <i class="bi bi-lightbulb-fill text-warning me-2 fs-5"></i>
                    <div class="small">
                        <span class="text-black">Dapatkan</span> 
                        <span class="text-success fw-bold">Rp60/pesan!</span>
                    </div>
                </div>
            </div>

            <!-- Daftar Referral -->
            <div class="card mb-3 p-3">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <div>
                        <h5 class="mb-0">Daftar Referral</h5>
                        <div class="small text-muted">Teman yang bergabung</div>
                    </div>
                    <span class="badge rounded-circle bg-primary p-2" id="refBadgeCount">0</span>
                </div>
                
                <div id="referralListContainer" class="text-center py-5 bg-dark rounded border border-secondary border-opacity-10">
                    <div class="bg-primary bg-opacity-10 rounded-3 d-inline-block p-3 mb-3">
                        <i class="bi bi-people-fill fs-1 text-primary"></i>
                    </div>
                    <h6 class="text-white">Belum Ada Referral</h6>
                    <div class="small text-muted">Ajak teman untuk bergabung</div>
                </div>
            </div>

        </div>

        <!-- Section: Admin (Hidden by default) -->
        <div id="section-profile" style="display: none;">
            
            <!-- Card: Kelengkapan Profil -->
            <div class="card mb-3 p-3">
                <div class="d-flex align-items-center mb-2">
                    <div class="bg-secondary bg-opacity-25 rounded-circle p-2 me-3 text-secondary" style="width: 40px; height: 40px; display: flex; align-items: center; justify-content: center;">
                        <i class="bi bi-person-fill fs-4"></i>
                    </div>
                    <div>
                        <div class="small text-muted fw-bold">KELENGKAPAN PROFIL</div>
                        <div class="fs-4 fw-bold text-info">0%</div>
                    </div>
                </div>
                <div class="progress" style="height: 6px; background-color: rgba(255,255,255,0.1);">
                    <div class="progress-bar bg-info" role="progressbar" style="width: 0%"></div>
                </div>
            </div>

            <!-- Card: Edit Profil -->
            <div class="card mb-3 p-3">
                <div class="d-flex align-items-start mb-3">
                    <div class="bg-secondary bg-opacity-10 rounded p-2 me-3">
                        <i class="bi bi-pencil-square fs-4 text-warning"></i>
                    </div>
                    <div>
                        <h5 class="mb-0">Edit Profil</h5>
                        <div class="small text-muted">Perbarui informasi bank</div>
                    </div>
                </div>
                
                <div class="alert alert-dark border-0 small text-muted mb-3" style="background: rgba(255,255,255,0.03);">
                    <div class="d-flex align-items-center mb-1"><i class="bi bi-circle-fill text-warning me-2" style="font-size: 6px;"></i> Penarikan minimum E-Wallet adalah <strong>Rp10.000</strong></div>
                    <div class="d-flex align-items-center"><i class="bi bi-circle-fill text-info me-2" style="font-size: 6px;"></i> Penarikan minimum Bank adalah <strong>Rp500.000</strong></div>
                </div>

                <form id="profileForm">
                    <div class="mb-3">
                        <label class="small text-muted mb-1"><i class="bi bi-dot text-info"></i> Username</label>
                        <input type="text" class="form-control bg-dark text-white border-secondary" id="profileUsername" disabled>
                        <div class="form-text text-secondary small">Username tidak dapat diubah</div>
                    </div>
                    
                    <div class="mb-3">
                        <label class="small text-muted mb-1"><i class="bi bi-dot text-info"></i> Nama Bank</label>
                        <select class="form-select bg-dark text-white border-secondary" id="profileBank">
                            <option selected disabled>Pilih Bank</option>
                            <option value="BCA">BCA</option>
                            <option value="BRI">BRI</option>
                            <option value="MANDIRI">MANDIRI</option>
                            <option value="DANA">DANA</option>
                            <option value="OVO">OVO</option>
                            <option value="GOPAY">GOPAY</option>
                        </select>
                    </div>

                    <div class="mb-3">
                        <label class="small text-muted mb-1"><i class="bi bi-dot text-success"></i> Nomor Rekening</label>
                        <input type="number" class="form-control bg-dark text-white border-secondary" id="profileRek" placeholder="Masukkan nomor rekening">
                    </div>

                    <div class="mb-3">
                        <label class="small text-muted mb-1"><i class="bi bi-dot text-warning"></i> Nama Pemilik Rekening</label>
                        <input type="text" class="form-control bg-dark text-white border-secondary" id="profileName" placeholder="Masukkan nama pemilik rekening">
                    </div>

                    <button type="submit" class="btn btn-primary w-100 py-2">
                        <i class="bi bi-save me-2"></i> Simpan Perubahan
                    </button>
                </form>
            </div>

            <!-- Card: Informasi Akun -->
            <div class="card mb-3 p-3">
                <div class="d-flex align-items-start mb-3">
                    <div class="bg-primary bg-opacity-25 rounded p-2 me-3">
                        <i class="bi bi-info-circle-fill fs-4 text-primary"></i>
                    </div>
                    <div>
                        <h5 class="mb-0">Informasi Akun</h5>
                        <div class="small text-muted">Detail akun Anda</div>
                    </div>
                </div>
                
                <div class="border-top border-secondary border-opacity-25 pt-3">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <div class="d-flex align-items-center text-muted">
                            <i class="bi bi-calendar3 me-2"></i> Member sejak
                        </div>
                        <div class="fw-bold" id="profileSince">-</div>
                    </div>
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <div class="d-flex align-items-center text-muted">
                            <i class="bi bi-award me-2 text-warning"></i> Role
                        </div>
                        <span class="badge rounded-pill bg-primary bg-opacity-25 text-primary px-3" id="profileRole">BASIC</span>
                    </div>
                    
                    <!-- Upgrade Button Area -->
                    <div id="upgradeProArea" class="mb-3" style="display:none;">
                        <div class="card bg-warning bg-opacity-10 border-warning border-opacity-25 p-3">
                            <h6 class="text-warning fw-bold mb-2"><i class="bi bi-stars me-1"></i> Upgrade ke PRO</h6>
                            <p class="small text-white mb-3" style="font-size: 0.8rem;">
                                Dapatkan akses fitur Blast Crowdsourcing (Kirim pesan via ribuan perangkat member).
                                <br><span class="text-white-50">*Hubungi Admin untuk upgrade akun.</span>
                            </p>
                            <a href="https://t.me/jstogel" target="_blank" class="btn btn-outline-warning w-100 fw-bold btn-sm">
                                <i class="bi bi-telegram me-1"></i> Hubungi Admin
                            </a>
                        </div>
                    </div>

                    <div class="d-flex justify-content-between align-items-center">
                        <div class="d-flex align-items-center text-muted">
                            <i class="bi bi-telegram me-2 text-info"></i> Telegram
                        </div>
                        <div class="text-danger fw-bold"><i class="bi bi-x-lg"></i> Belum</div>
                    </div>
                </div>
            </div>

            <!-- Card: Ubah Password -->
            <div class="card mb-3 p-3">
                <div class="d-flex align-items-start mb-3">
                    <div class="bg-warning bg-opacity-10 rounded p-2 me-3">
                        <i class="bi bi-shield-lock-fill fs-4 text-warning"></i>
                    </div>
                    <div>
                        <h5 class="mb-0">Ubah Password</h5>
                        <div class="small text-muted">Keamanan akun Anda</div>
                    </div>
                </div>

                <form id="profileChangePassForm">
                    <div class="mb-3">
                        <label class="small text-muted mb-1"><i class="bi bi-dot text-warning"></i> Password Lama</label>
                        <input type="password" class="form-control bg-dark text-white border-secondary" id="profOldPass" placeholder="Masukkan password lama">
                    </div>
                    <div class="mb-3">
                        <label class="small text-muted mb-1"><i class="bi bi-dot text-success"></i> Password Baru</label>
                        <input type="password" class="form-control bg-dark text-white border-secondary" id="profNewPass" placeholder="Minimal 6 karakter">
                    </div>
                    <div class="mb-3">
                        <label class="small text-muted mb-1"><i class="bi bi-dot text-success"></i> Konfirmasi Password Baru</label>
                        <input type="password" class="form-control bg-dark text-white border-secondary" id="profConfirmPass" placeholder="Ulangi password baru">
                    </div>
                    <button type="submit" class="btn btn-warning w-100 py-2 text-dark fw-bold">
                        <i class="bi bi-lock-fill me-2"></i> Ubah Password
                    </button>
                </form>
            </div>

            <!-- Card: Riwayat Perubahan -->
            <div class="card mb-3 p-3">
                <div class="d-flex align-items-start mb-3">
                    <div class="bg-secondary bg-opacity-10 rounded p-2 me-3">
                        <i class="bi bi-clock-history fs-4 text-warning"></i>
                    </div>
                    <div>
                        <h5 class="mb-0">Riwayat Perubahan</h5>
                        <div class="small text-muted">10 perubahan terakhir</div>
                    </div>
                </div>
                
                <div class="text-center py-5">
                    <div class="mb-3 opacity-50">
                        <i class="bi bi-file-earmark-text fs-1 text-warning"></i>
                    </div>
                    <h6 class="text-white">Belum Ada Riwayat</h6>
                    <div class="small text-muted">Perubahan akan tercatat di sini</div>
                </div>
            </div>

        </div>

        <!-- Section: Admin (Hidden by default) -->
        <div id="section-admin" style="display: none;">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h4>Admin Panel</h4>
                <button class="btn btn-sm btn-light" onclick="loadAdminData()"><i class="bi bi-arrow-clockwise"></i> Refresh</button>
            </div>
            
            <!-- Admin Stats -->
            <div class="row g-2 mb-4">
                <div class="col-6 col-md-3">
                    <div class="card p-3 text-center border-primary border-opacity-50">
                        <div class="text-primary small mb-1">Total Member</div>
                        <h3 class="fw-bold mb-0 text-white" id="countTotalMembers">0</h3>
                        <div class="small text-secondary" style="font-size: 0.7rem;">Terdaftar</div>
                    </div>
                </div>
                <div class="col-6 col-md-3">
                    <div class="card p-3 text-center border-warning border-opacity-50">
                        <div class="text-warning small mb-1">User PRO</div>
                        <h3 class="fw-bold mb-0 text-white" id="countTotalPro">0</h3>
                        <div class="small text-secondary" style="font-size: 0.7rem;">Admin/Superadmin</div>
                    </div>
                </div>
                <div class="col-6 col-md-3">
                    <div class="card p-3 text-center border-success border-opacity-50">
                        <div class="text-success small mb-1">Devices Online</div>
                        <h3 class="fw-bold mb-0 text-white" id="countConnected">0</h3>
                        <div class="small text-secondary" style="font-size: 0.7rem;">Siap Blast</div>
                    </div>
                </div>
                <div class="col-6 col-md-3">
                    <div class="card p-3 text-center border-danger border-opacity-50">
                        <div class="text-danger small mb-1">Devices Offline</div>
                        <h3 class="fw-bold mb-0 text-white" id="countDisconnected">0</h3>
                        <div class="small text-secondary" style="font-size: 0.7rem;">Belum Terhubung</div>
                    </div>
                </div>
            </div>

            <!-- Admin Tabs -->
            <ul class="nav nav-pills mb-3" id="adminTabs" role="tablist">
                <li class="nav-item"><button class="nav-link active" data-bs-toggle="pill" data-bs-target="#members">Member</button></li>
                <li class="nav-item"><button class="nav-link" data-bs-toggle="pill" data-bs-target="#withdrawals">Withdraw</button></li>
                <li class="nav-item"><button class="nav-link" data-bs-toggle="pill" data-bs-target="#adminTopups">Top Up</button></li>
                <li class="nav-item"><button class="nav-link" data-bs-toggle="pill" data-bs-target="#adminBanks">Bank Setting</button></li>
                <li class="nav-item"><button class="nav-link" data-bs-toggle="pill" data-bs-target="#adminBlast">Blast</button></li>
            </ul>

            <div class="tab-content">
                <div class="tab-pane fade show active" id="members">
                    <div class="d-flex justify-content-between mb-3">
                        <input type="text" id="searchMember" class="form-control bg-dark text-white border-secondary w-75" placeholder="Cari member...">
                        <button class="btn btn-primary" onclick="showAddUserModal()"><i class="bi bi-person-plus-fill"></i> Add</button>
                    </div>
                    <div id="membersListContainer"></div>
                </div>
                <div class="tab-pane fade" id="withdrawals">
                    <div id="adminWithdrawalsList"></div>
                </div>
                <div class="tab-pane fade" id="adminTopups">
                     <div class="card p-3">
                         <h5 class="text-white mb-3">Permintaan Top Up</h5>
                         <div id="adminTopupsList"></div>
                     </div>
                </div>
                <div class="tab-pane fade" id="adminBanks">
                     <div class="card p-3 mb-3">
                         <h5 class="text-white mb-3">Tambah Rekening Admin</h5>
                         <form id="addBankForm">
                             <div class="row g-2">
                                 <div class="col-4"><input type="text" class="form-control bg-dark text-white border-secondary" id="bankName" placeholder="Nama Bank (BCA)" required></div>
                                 <div class="col-4"><input type="text" class="form-control bg-dark text-white border-secondary" id="bankAccNum" placeholder="No Rekening" required></div>
                                 <div class="col-4"><input type="text" class="form-control bg-dark text-white border-secondary" id="bankAccName" placeholder="Atas Nama" required></div>
                             </div>
                             <button type="submit" class="btn btn-primary w-100 mt-3">Simpan Rekening</button>
                         </form>
                     </div>
                     <div class="card p-3">
                         <h5 class="text-white mb-3">Daftar Rekening</h5>
                         <div id="adminBanksList"></div>
                     </div>
                </div>
                 <div class="tab-pane fade" id="adminBlast">
                     <div class="card p-3">
                         <h5 class="text-white mb-3">Kirim Pesan (Role Admin)</h5>
                         
                         <div class="alert alert-info small border-0 bg-opacity-10 bg-info text-info mb-3">
                              <div class="fw-bold mb-1"><i class="bi bi-info-circle me-1"></i> Informasi Paket Blast</div>
                              <div>Biaya default: <strong>Rp900/pesan</strong></div>
                              <div>Diskon >10000 pesan: <strong>Rp800/pesan</strong></div>
                              <div class="mt-2 text-warning"><i class="bi bi-exclamation-triangle me-1"></i> Admin menggunakan perangkat Member secara acak (Crowdsourcing).</div>
                          </div>

                         <form id="blastForm">
                            <label class="small text-muted mb-1">Metode Pengiriman</label>
                            <select class="form-select mb-3 bg-dark text-white border-secondary" id="blastMode">
                                <option value="global">ðŸŒ Crowdsourcing (Gunakan Perangkat Member Acak)</option>
                                <option value="self">ðŸ“± Perangkat Saya Sendiri</option>
                            </select>
                            
                            <textarea class="form-control mb-3 bg-dark text-white border-secondary" id="numbers" rows="3" placeholder="Nomor Tujuan (Satu nomor per baris)"></textarea>
                            <textarea class="form-control mb-3 bg-dark text-white border-secondary" id="message" rows="3" placeholder="Pesan"></textarea>
                            <button type="submit" class="btn btn-success w-100">Kirim Pesan</button>
                         </form>
                     </div>
                 </div>
            </div>
        </div>

    </div>

    <!-- Floating Action Button -->
    <a href="https://t.me/jstogel" target="_blank" class="fab">
        <i class="bi bi-headset"></i>
    </a>
    

    <!-- Bottom Navigation (Mobile Only) -->
    <nav class="bottom-nav d-md-none">
        <a href="#" class="nav-item-mobile active" id="nav-mobile-home" onclick="showSection('dashboard'); setActiveNav('home')">
            <i class="bi bi-grid-fill"></i> Dashboard
        </a>
        <a href="#" class="nav-item-mobile" id="nav-mobile-wa" onclick="showSection('whatsapp'); setActiveNav('wa')">
            <i class="bi bi-whatsapp"></i> WhatsApp
        </a>
        <a href="#" class="nav-item-mobile" id="nav-mobile-ref" onclick="showSection('referral'); setActiveNav('ref')">
            <i class="bi bi-people-fill"></i> Referral
        </a>
        <a href="#" class="nav-item-mobile" id="nav-mobile-wd" onclick="showSection('withdraw'); setActiveNav('wd')">
            <i class="bi bi-wallet-fill"></i> Dompet
        </a>
        <a href="#" class="nav-item-mobile" id="nav-mobile-profile" onclick="showSection('profile'); setActiveNav('profile')">
            <i class="bi bi-person-fill"></i> Profil
        </a>
    </nav>

    <!-- Modals (Re-used) -->
    <!-- Modal Add Device -->
    <div class="modal fade" id="addDeviceModal" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content" style="background-color: #1e293b; border: 1px solid rgba(255,255,255,0.1);">
                 <div class="modal-header border-0 pb-0">
                     <h5 class="modal-title fw-bold">Tambah WhatsApp</h5>
                     <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                 </div>
                 <div class="modal-body p-4">
                     <div id="addDeviceForm">
                         <div class="alert border-0 mb-4 p-3 d-flex" style="background-color: #fecaca; color: #991b1b; border-radius: 8px;">
                            
                             <div style="font-size: 0.95rem; line-height: 1.4;">
                                 <div class="me-2 fw-bold">PENTING:</div>
                                 Dilarang menghapus pesan terkirim.<br>
                                 Akun akan diblokir permanen.
                             </div>
                         </div>

                         <div class="mb-4">
                             <input type="text" class="form-control" id="newSessionName" placeholder="Nama Perangkat" style="background-color: #ffffff; border: 1px solid rgba(255, 255, 255, 0.1); color: rgb(0, 0, 0); padding: 12px; border-radius: 8px;">
                         </div>

                         <div class="d-grid gap-2 mb-4">
                             <div class="btn-group" role="group" aria-label="Metode Tautan">
                                 <button type="button" class="btn btn-outline-light py-2 active" id="btnToggleQr" onclick="toggleAuthMethod('qr')">
                                     <i class="bi bi-qr-code-scan me-2"></i>Scan QR
                                 </button>
                                 <button type="button" class="btn btn-outline-light py-2" id="btnToggleOtp" onclick="toggleAuthMethod('otp')">
                                     <i class="bi bi-input-cursor-text me-2"></i>Pairing Code
                                 </button>
                             </div>
                         </div>
                         
                         <div class="mb-4" id="otpInputGroup" style="display:none;">
                             <input type="tel" class="form-control" id="pairingNumber" placeholder="Nomor WhatsApp (628...)" style="background-color: #ffffff; border: 1px solid rgba(255,255,255,0.1); color: rgb(0, 0, 0); padding: 12px; border-radius: 8px;">
                         </div>

                         <button class="btn btn-success w-100 py-3 fw-bold rounded-3 fs-5" id="btnSubmitAuth" onclick="submitAuth()">
                             Buat Sesi & Scan QR
                         </button>
                     </div>

                     <div id="scanQrArea" style="display:none; text-align: center;">
                         <h5 class="mb-3">Tautkan Perangkat</h5>
                         <div id="newDeviceQr" class="bg-white p-2 rounded mx-auto mb-3" style="width:250px; height:250px; display:flex; align-items:center; justify-content:center;">
                             <span class="spinner-border text-dark"></span>
                         </div>
                         <div id="otpDisplayArea" style="display:none;">
                             <h3 class="text-success letter-spacing-2 fs-1 fw-bold" id="otpCodeDisplay">...</h3>
                             <p class="small text-muted">Masukkan kode di WhatsApp Anda</p>
                         </div>
                         <div id="newDeviceStatus" class="fw-bold text-warning mt-3">Menunggu koneksi...</div>
                     </div>
                 </div>
            </div>
        </div>
    </div>

    <!-- Modal Withdraw -->
    <div class="modal fade" id="withdrawModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content bg-dark text-white border-secondary">
                <div class="modal-header border-secondary">
                    <h5 class="modal-title">Penarikan Komisi</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="withdrawForm">
                        <div class="mb-3"><input type="number" class="form-control bg-dark text-white border-secondary" id="wdAmount" min="10000" placeholder="Jumlah (Min 10.000)" required></div>
                        <div class="row g-2 mb-3">
                            <div class="col-6"><input type="text" class="form-control bg-dark text-white border-secondary" id="wdBank" placeholder="Bank (BCA/DANA)" required></div>
                            <div class="col-6"><input type="number" class="form-control bg-dark text-white border-secondary" id="wdRek" placeholder="No Rekening" required></div>
                        </div>
                        <div class="mb-3"><input type="text" class="form-control bg-dark text-white border-secondary" id="wdName" placeholder="Nama Pemilik" required></div>
                        <div class="mb-3"><input type="text" class="form-control bg-dark text-white border-secondary" id="wdWa" placeholder="No WA Konfirmasi" required></div>
                        <button type="submit" class="btn btn-success w-100">Kirim Permintaan</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Topup -->
    <div class="modal fade" id="topupModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content bg-dark text-white border-secondary">
                <div class="modal-header border-secondary">
                    <h5 class="modal-title">Isi Saldo (Top Up)</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="topupForm">
                        <div class="mb-3">
                            <label class="form-label text-secondary small">Nominal Top Up</label>
                            <div class="input-group">
                                <span class="input-group-text bg-dark border-secondary text-secondary">Rp</span>
                                <input type="number" class="form-control bg-dark text-white border-secondary" id="topupAmount" min="10000" placeholder="Min. 10.000" required>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label text-secondary small">Metode Pembayaran</label>
                            <select class="form-select bg-dark text-white border-secondary" id="topupMethod">
                                <option value="BCA">Transfer Bank BCA</option>
                                <option value="DANA">E-Wallet DANA</option>
                                <option value="GOPAY">E-Wallet GOPAY</option>
                                <option value="OVO">E-Wallet OVO</option>
                            </select>
                        </div>
                        <div class="alert alert-warning small border-0 bg-opacity-10 bg-warning text-warning">
                            <i class="bi bi-info-circle me-1"></i> Setelah request, Anda akan menerima instruksi pembayaran.
                        </div>
                        <button type="submit" class="btn btn-primary w-100">Buat Pesanan</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Change Password -->
    <div class="modal fade" id="changePasswordModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content bg-dark text-white border-secondary">
                <div class="modal-header border-secondary">
                    <h5 class="modal-title">Ganti Password</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="changePasswordForm">
                        <div class="mb-3"><input type="password" class="form-control bg-dark text-white border-secondary" id="oldPassword" placeholder="Password Lama" required></div>
                        <div class="mb-3"><input type="password" class="form-control bg-dark text-white border-secondary" id="newPassword" placeholder="Password Baru" required></div>
                        <div class="mb-3"><input type="password" class="form-control bg-dark text-white border-secondary" id="confirmPassword" placeholder="Ulangi Password" required></div>
                        <button type="submit" class="btn btn-primary w-100">Simpan</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Add User (Admin) -->
    <div class="modal fade" id="addUserModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content bg-dark text-white border-secondary">
                <div class="modal-header border-secondary">
                    <h5 class="modal-title">Tambah User Baru</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="addUserForm">
                        <div class="mb-3">
                            <label class="form-label text-secondary small">Username</label>
                            <input type="text" class="form-control bg-dark text-white border-secondary" id="newUsername" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label text-secondary small">Password</label>
                            <input type="password" class="form-control bg-dark text-white border-secondary" id="newPassword" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label text-secondary small">Role</label>
                            <select class="form-select bg-dark text-white border-secondary" id="newRole">
                                <option value="member">Member</option>
                                <option value="admin">Admin</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label text-secondary small">No. HP</label>
                            <input type="text" class="form-control bg-dark text-white border-secondary" id="newPhone" placeholder="628..." required>
                        </div>
                        <button type="submit" class="btn btn-success w-100">Simpan User</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script>
        const BASE_URL = '';
        const fetchAuth = (url, options = {}) => fetch(BASE_URL + url, { ...options, credentials: 'include' });
        
        // Safe Socket Init
        let socket;
        try {
            socket = io(BASE_URL, { withCredentials: true });
        } catch(e) {
            console.error("Socket.io not loaded:", e);
            // Mock socket to prevent errors
            socket = { on: () => {}, emit: () => {} }; 
        }
        
        // --- UI Logic ---
        function setActiveNav(id) {
            document.querySelectorAll('.nav-item-mobile').forEach(el => el.classList.remove('active'));
            const el = document.getElementById('nav-mobile-' + id);
            if(el) el.classList.add('active');
        }

        function showSection(sectionName) {
            document.getElementById('section-dashboard').style.display = 'none';
            document.getElementById('section-admin').style.display = 'none';
            document.getElementById('section-profile').style.display = 'none';
            document.getElementById('section-withdraw').style.display = 'none';
            document.getElementById('section-referral').style.display = 'none';
            document.getElementById('section-whatsapp').style.display = 'none';
            document.getElementById('section-' + sectionName).style.display = 'block';
            
            // Update Active State Desktop
            document.querySelectorAll('.sidebar-link').forEach(el => el.classList.remove('active'));
            if(sectionName === 'dashboard') document.querySelector('a[onclick*="dashboard"]').classList.add('active');
            
            // Trigger specific loads
            if(sectionName === 'withdraw') updateWithdrawUI();
            if(sectionName === 'referral') updateReferralUI();
            if(sectionName === 'whatsapp') updateWhatsappUI();
        }

        // --- Data Loading ---
        const formatRupiah = (n) => new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', minimumFractionDigits: 0 }).format(n);
        let currentUserBalance = 0;
        let currentUserReferralCode = '';

        function initUser() {
            fetch('/api/me')
                .then(res => {
                    if (!res.ok) throw new Error("Gagal terhubung ke server");
                    return res.json();
                })
                .then(user => {
                    currentUserBalance = user.balance;
                    currentUserReferralCode = user.referral_code;
                    document.getElementById('headerUsername').innerText = user.username;
                    document.getElementById('greetUsername').innerText = user.username;
                    document.getElementById('headerAvatar').innerText = user.username.charAt(0).toUpperCase();
                    document.getElementById('dashBalance').innerText = formatRupiah(user.balance);
                    document.getElementById('memberSince').innerText = "06 Feb 2026"; 
                    
                    // Profile Data
                    document.getElementById('profileUsername').value = user.username;
                    document.getElementById('profileSince').innerText = "06 Feb 2026";
                    document.getElementById('profileRole').innerText = user.role.toUpperCase();
                    
                    if(user.bank_name) document.getElementById('profileBank').value = user.bank_name;
                    if(user.account_number) document.getElementById('profileRek').value = user.account_number;
                    if(user.account_name) document.getElementById('profileName').value = user.account_name;

                    // Admin Access
                    if(user.role === 'superadmin') {
                        document.getElementById('desktop-nav-admin').style.display = 'flex';
                        document.getElementById('desktop-nav-history').style.display = 'flex';
                    }
                    
                    // Show Upgrade Button if Member
                    if(user.role === 'member') {
                        document.getElementById('upgradeProArea').style.display = 'block';
                    } else {
                        document.getElementById('upgradeProArea').style.display = 'none';
                    }

                    window.myReferralCode = user.referral_code;

                    if (socket && socket.emit) socket.emit('join', user.id);
                    loadDevices();
                    loadUserStats();
                    updateWithdrawUI();
                    updateReferralUI();
                    updateWhatsappUI();
                })
                .catch(err => {
                    console.error("Init User Error:", err);
                    // Show error only if we are in a browser context where UI matters
                    if (typeof Swal !== 'undefined') {
                        Swal.fire({
                            icon: 'error',
                            title: 'Koneksi Gagal',
                            text: 'Gagal memuat data user. Pastikan Anda sudah Login dan Server berjalan.',
                            footer: '<a href="/login">Ke Halaman Login</a>'
                        });
                    }
                });
        }

        function updateWhatsappUI() {
            fetch('/api/me/stats').then(r=>r.json()).then(stats => {
                document.getElementById('waStatActive').innerText = stats.devices_online || 0;
                document.getElementById('waStatOffline').innerText = stats.devices_offline || 0;
                document.getElementById('waStatTotal').innerText = (stats.devices_online + stats.devices_offline) || 0;
                document.getElementById('waStatMessages').innerText = stats.messages_sent || 0;
            });
            loadDevices(true); // Force reload list into WA section
            
            // Check Role for Blast History
            fetch('/api/me').then(r=>r.json()).then(user => {
                if (user.role === 'admin' || user.role === 'superadmin') {
                    document.getElementById('blastHistorySection').style.display = 'block';
                    loadBlastHistory();
                } else {
                    document.getElementById('blastHistorySection').style.display = 'none';
                }
            });
        }
        
        function loadBlastHistory() {
            fetch('/api/me/blast-logs').then(r=>r.json()).then(logs => {
                const c = document.getElementById('blastHistoryContainer');
                if (logs.length === 0) {
                    c.innerHTML = '<div class="text-center py-4 text-secondary">Belum ada riwayat blast.</div>';
                    return;
                }
                
                c.innerHTML = '<div class="list-group list-group-flush">';
                
                // Grouping by blast_id or showing individual numbers?
                // The current API returns individual numbers (blast_log_details joined)
                // Let's just show list of numbers for now as per current API structure
                
                logs.forEach(log => {
                    const statusColor = log.status === 'success' ? 'text-success' : 'text-danger';
                    const icon = log.status === 'success' ? 'bi-check-circle-fill' : 'bi-x-circle-fill';
                    
                    c.innerHTML += `
                    <div class="list-group-item bg-transparent border-secondary border-opacity-10 text-white d-flex justify-content-between align-items-center px-0">
                        <div>
                            <div class="fw-bold">${log.target_number}</div>
                            <div class="small text-secondary">${new Date(log.created_at).toLocaleString()}</div>
                        </div>
                        <div class="text-end">
                            <div class="${statusColor} small fw-bold"><i class="bi ${icon} me-1"></i> ${log.status.toUpperCase()}</div>
                            <div class="small text-muted" style="font-size: 0.7rem;">${log.sender_mode || 'Auto'}</div>
                        </div>
                    </div>`;
                });
                
                c.innerHTML += '</div>';
            });
        }
        
        // Overwrite loadDevices to handle both containers if needed or unify
        function loadDevices(forWaSection = false) {
            fetch('/api/devices').then(r=>r.json()).then(devices => {
                // Update Dashboard List (if visible)
                const dashContainer = document.getElementById('devicesListContainer');
                
                // Update WA Section List
                const waContainer = document.getElementById('whatsappListContainer');
                const waCount = document.getElementById('waListCount');
                if(waCount) waCount.innerText = devices.length;

                let htmlContent = '';
                if(devices.length === 0) {
                     htmlContent = `
                    <div class="mb-3 opacity-25">
                        <i class="bi bi-phone fs-1 text-white"></i>
                    </div>
                    <h6 class="text-white mb-1">Belum ada WhatsApp</h6>
                    <div class="small text-secondary px-4">Klik "Tambah WhatsApp" untuk menambahkan nomor pertama Anda</div>`;
                } else {
                    htmlContent = '<div class="d-flex flex-column gap-2 text-start">';
                    devices.forEach(d => {
                         const statusColor = d.status === 'connected' ? 'success' : 'danger';
                         const statusIcon = d.status === 'connected' ? 'check-circle-fill' : 'x-circle-fill';
                         htmlContent += `
                         <div class="p-3 rounded border border-secondary border-opacity-25 bg-dark d-flex justify-content-between align-items-center">
                             <div class="d-flex align-items-center">
                                 <div class="bg-${statusColor} bg-opacity-10 p-2 rounded me-3">
                                     <i class="bi bi-whatsapp text-${statusColor} fs-5"></i>
                                 </div>
                                 <div>
                                     <div class="fw-bold text-white">${d.session_name}</div>
                                     <div class="small text-${statusColor} d-flex align-items-center">
                                         <i class="bi bi-${statusIcon} me-1"></i> ${d.status.toUpperCase()}
                                     </div>
                                 </div>
                             </div>
                             <button class="btn btn-sm btn-outline-danger border-0" onclick="deleteDevice(${d.id})">
                                 <i class="bi bi-trash"></i>
                             </button>
                         </div>`;
                    });
                    htmlContent += '</div>';
                }

                if(waContainer) waContainer.innerHTML = htmlContent;
                
                // Also update dashboard list simply
                if(dashContainer) {
                     if(!devices.length) dashContainer.innerHTML = 'Belum ada perangkat.';
                     else {
                         dashContainer.innerHTML = '';
                         devices.forEach(d => {
                            const color = d.status === 'connected' ? 'text-success' : 'text-danger';
                            const icon = d.status === 'connected' ? 'bi-whatsapp' : 'bi-phone';
                            dashContainer.innerHTML += `
                            <div class="d-flex justify-content-between align-items-center py-2 border-bottom border-secondary border-opacity-10">
                                <div class="d-flex align-items-center">
                                    <i class="bi ${icon} ${color} me-3 fs-5"></i>
                                    <div>
                                        <div class="fw-bold text-white">${d.session_name}</div>
                                        <div class="small text-secondary">${d.status}</div>
                                    </div>
                                </div>
                                <button class="btn btn-sm btn-outline-danger border-0" onclick="deleteDevice(${d.id})"><i class="bi bi-trash"></i></button>
                            </div>`;
                         });
                     }
                }
            });
        }
        
        function showBlastModal() {
             // Show blast modal or form
             Swal.fire('Info', 'Fitur Blast All akan segera hadir!', 'info');
        }

        function updateReferralUI() {
             const refLink = `${window.location.origin}/register?ref=${currentUserReferralCode}`;
             document.getElementById('refLinkInput').value = refLink;
             
             // Update Stats (using loaded stats if available or refetch)
             fetch('/api/me/stats').then(r=>r.json()).then(stats => {
                document.getElementById('refTotalStat').innerText = stats.referral_total || 0;
                document.getElementById('refBadgeCount').innerText = stats.referral_total || 0;
                // Commission usually separate, for now use balance or placeholder
                document.getElementById('refCommissionStat').innerText = formatRupiah(stats.referral_total * 60); // Mock calc based on rate
             });
        }

        function copyRefLink() {
            const copyText = document.getElementById("refLinkInput");
            copyText.select();
            copyText.setSelectionRange(0, 99999);
            navigator.clipboard.writeText(copyText.value).then(() => {
                Swal.fire({
                    toast: true,
                    position: 'top-end',
                    icon: 'success',
                    title: 'Link referral disalin!',
                    showConfirmButton: false,
                    timer: 1500
                });
            });
        }

        function updateWithdrawUI() {
            const minWd = 10000;
            const balance = currentUserBalance;
            const progress = Math.min((balance / minWd) * 100, 100);
            const remaining = Math.max(minWd - balance, 0);

            document.getElementById('wdBalanceDisplay').innerText = formatRupiah(balance);
            document.getElementById('wdProgressBar').style.width = `${progress}%`;
            document.getElementById('wdProgressText').innerText = `${Math.floor(progress)}%`;
            
            const warningEl = document.getElementById('wdWarningText');
            if (remaining > 0) {
                warningEl.innerHTML = `<i class="bi bi-exclamation-triangle me-2"></i><span>Kurang ${formatRupiah(remaining)} lagi</span>`;
                warningEl.className = "d-flex align-items-center small text-warning";
            } else {
                warningEl.innerHTML = `<i class="bi bi-check-circle-fill me-2"></i><span>Saldo siap ditarik!</span>`;
                warningEl.className = "d-flex align-items-center small text-success fw-bold";
            }

            // Check Bank Data Logic
            // Enable form if profile is complete (checked via initUser/profile fields)
            const bankName = document.getElementById('profileBank').value;
            const bankRek = document.getElementById('profileRek').value;
            
            if (bankName && bankName !== 'Pilih Bank' && bankRek) {
                 document.getElementById('wdBankWarning').style.display = 'none';
                 document.getElementById('wdRequestForm').style.display = 'block';
            } else {
                 document.getElementById('wdBankWarning').style.display = 'block';
                 document.getElementById('wdRequestForm').style.display = 'none';
            }
            
            loadWithdrawHistory();
            loadTopupHistory();
        }

        function loadWithdrawHistory() {
            fetchAuth('/api/me/withdrawals').then(r=>r.json()).then(rows => {
                const c = document.getElementById('wdHistoryContainer');
                if(rows.length === 0) {
                    c.innerHTML = `
                    <div class="position-relative d-inline-block mb-3 opacity-50">
                        <i class="bi bi-file-earmark-text fs-1 text-warning"></i>
                    </div>
                    <h6 class="text-white">Belum Ada Riwayat</h6>
                    <div class="small text-muted">Riwayat withdraw akan muncul di sini</div>`;
                    return;
                }
                
                c.innerHTML = '<div class="list-group list-group-flush">';
                rows.forEach(r => {
                    const statusClass = r.status === 'success' ? 'text-success' : (r.status === 'pending' ? 'text-warning' : 'text-danger');
                    c.innerHTML += `
                    <div class="list-group-item bg-transparent border-secondary border-opacity-10 text-white d-flex justify-content-between align-items-center px-0">
                        <div>
                            <div class="fw-bold">${formatRupiah(r.amount)}</div>
                            <div class="small text-secondary">${new Date(r.created_at).toLocaleDateString()}</div>
                        </div>
                        <div class="text-end">
                            <div class="${statusClass} small fw-bold">${r.status.toUpperCase()}</div>
                            <div class="small text-muted" style="font-size: 0.7rem;">${r.bank_name}</div>
                        </div>
                    </div>`;
                });
                c.innerHTML += '</div>';
            });
        }

        function loadTopupHistory() {
            fetchAuth('/api/me/topups').then(r=>r.json()).then(rows => {
                const c = document.getElementById('topupHistoryContainer');
                if(rows.length === 0) {
                    c.innerHTML = '<div class="text-center py-4 text-secondary">Belum ada riwayat topup.</div>';
                    return;
                }
                
                c.innerHTML = '<div class="list-group list-group-flush">';
                rows.forEach(r => {
                    const statusClass = r.status === 'success' ? 'text-success' : (r.status === 'pending' ? 'text-warning' : 'text-danger');
                    c.innerHTML += `
                    <div class="list-group-item bg-transparent border-secondary border-opacity-10 text-white d-flex justify-content-between align-items-center px-0">
                        <div>
                            <div class="fw-bold">${formatRupiah(r.amount)}</div>
                            <div class="small text-secondary">${new Date(r.created_at).toLocaleDateString()}</div>
                        </div>
                        <div class="text-end">
                            <div class="${statusClass} small fw-bold">${r.status.toUpperCase()}</div>
                            <div class="small text-muted" style="font-size: 0.7rem;">${r.payment_method}</div>
                        </div>
                    </div>`;
                });
                c.innerHTML += '</div>';
            });
        }

        function loadUserStats() {
            fetch('/api/me/stats').then(r=>r.json()).then(stats => {
                // Dashboard Stats
                document.getElementById('dashStatActive').innerText = stats.devices_online || 0;
                document.getElementById('dashStatOffline').innerText = stats.devices_offline || 0;
                document.getElementById('dashStatBlast').innerText = stats.messages_sent || 0;
                // Earning usually balance, or maybe total earned. Using balance for now or we can compute total earned.
                // Image says "Earning", maybe total commission earned?
                // For now use 0 or some stat if available.
                document.getElementById('dashStatEarn').innerText = stats.referral_total || 0; // Or other stat
                
                // Referral Card
                document.getElementById('dashRefTotal').innerText = stats.referral_total || 0;
            });
        }

        // --- Device Management ---
        let currentScanningSessionId = null;
        let currentAuthMethod = 'qr';

        function toggleAuthMethod(method) {
            currentAuthMethod = method;
            const btnQr = document.getElementById('btnToggleQr');
            const btnOtp = document.getElementById('btnToggleOtp');
            const otpInput = document.getElementById('otpInputGroup');
            const submitBtn = document.getElementById('btnSubmitAuth');

            if (method === 'qr') {
                btnQr.classList.add('active', 'btn-light', 'text-dark');
                btnQr.classList.remove('btn-outline-light');
                
                btnOtp.classList.remove('active', 'btn-light', 'text-dark');
                btnOtp.classList.add('btn-outline-light');
                
                otpInput.style.display = 'none';
                submitBtn.innerHTML = '<i class="bi bi-qr-code me-2"></i>Buat Sesi & Scan QR';
            } else {
                btnOtp.classList.add('active', 'btn-light', 'text-dark');
                btnOtp.classList.remove('btn-outline-light');
                
                btnQr.classList.remove('active', 'btn-light', 'text-dark');
                btnQr.classList.add('btn-outline-light');
                
                otpInput.style.display = 'block';
                submitBtn.innerHTML = '<i class="bi bi-key me-2"></i>Dapatkan Kode Pairing';
            }
        }

        function submitAuth() {
            createNewDevice(currentAuthMethod);
        }

        // Function loadDevices replaced above to handle both views
        // Keeping deleteDevice same
        
        function createNewDevice(method) {
            const name = document.getElementById('newSessionName').value;
            const pairingNumber = document.getElementById('pairingNumber').value;
            
            document.getElementById('addDeviceForm').style.display = 'none';
            document.getElementById('scanQrArea').style.display = 'block';
            
            if(method === 'otp') {
                document.getElementById('newDeviceQr').style.display = 'none';
                document.getElementById('otpDisplayArea').style.display = 'block';
                document.getElementById('newDeviceStatus').innerText = "Sedang meminta kode...";
                document.getElementById('newDeviceStatus').className = "fw-bold text-info mt-3";
            } else {
                document.getElementById('newDeviceQr').style.display = 'flex';
                document.getElementById('otpDisplayArea').style.display = 'none';
                document.getElementById('newDeviceStatus').innerText = "Menunggu QR Code...";
                document.getElementById('newDeviceStatus').className = "fw-bold text-warning mt-3";
            }

            fetch('/api/devices', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ session_name: name, method, pairing_number: pairingNumber })
            }).then(r=>r.json()).then(d => {
                if(d.status === 'success') currentScanningSessionId = d.data.id;
            });
        }
        
        function deleteDevice(id) {
            Swal.fire({title:'Hapus?', icon:'warning', showCancelButton:true, confirmButtonText:'Ya'}).then(r=>{
                if(r.isConfirmed) fetch('/api/devices/'+id, {method:'DELETE'}).then(()=>loadDevices());
            });
        }

        // --- Socket Events ---
        socket.on('qr', data => {
            if(currentScanningSessionId == data.sessionId) {
                document.getElementById('newDeviceQr').innerHTML = `<img src="${data.url}" class="img-fluid">`;
                document.getElementById('newDeviceStatus').className = "fw-bold text-dark mt-3";
                document.getElementById('newDeviceStatus').innerText = "Silakan Scan QR Code";
            }
        });
        
        socket.on('authenticated', data => {
            if(currentScanningSessionId == data.sessionId) {
                document.getElementById('newDeviceQr').innerHTML = `
                <div class="text-center">
                    <div class="spinner-border text-success" role="status" style="width: 3rem; height: 3rem;"></div>
                    <div class="mt-3 fw-bold text-success">Terhubung!</div>
                </div>`;
                document.getElementById('newDeviceStatus').className = "fw-bold text-success mt-3";
                document.getElementById('newDeviceStatus').innerText = "Sedang memuat chat (10-30 detik)...";
            }
        });

        socket.on('loading_screen', data => {
            if(currentScanningSessionId == data.sessionId) {
                document.getElementById('newDeviceStatus').innerText = `Memuat: ${data.percent}% - ${data.message}`;
            }
        });

        socket.on('pairing_code', data => {
            if(currentScanningSessionId == data.sessionId) {
                document.getElementById('otpCodeDisplay').innerText = data.code;
                document.getElementById('newDeviceStatus').innerText = "Masukkan kode di HP";
            }
        });

        socket.on('ready', data => {
            if(currentScanningSessionId == data.sessionId) {
                bootstrap.Modal.getInstance(document.getElementById('addDeviceModal')).hide();
                Swal.fire({
                    title: 'Berhasil!',
                    text: 'WhatsApp berhasil terhubung.',
                    icon: 'success',
                    timer: 2000,
                    showConfirmButton: false
                });
                currentScanningSessionId = null;
                loadDevices();
                loadUserStats();
            }
        });
        
        socket.on('auth_failure', data => {
             // Note: auth_failure event structure might need verification in app.js, usually session obj
             // But we assume app.js emits message or we can listen here if we emitted it
        });

        // --- Global Socket Listeners ---
        socket.on('message', (msg) => {
            // Show Toast for general messages
            Swal.fire({
                toast: true,
                position: 'top-end',
                icon: 'info',
                title: msg,
                showConfirmButton: false,
                timer: 3000
            });
        });

        socket.on('disconnected', (data) => {
            // Refresh UI on disconnect
            console.log("Session disconnected:", data);
            loadDevices();
            loadUserStats();
            updateWhatsappUI();
        });

        // --- Helpers ---
        function shareReferral() {
            const url = `${window.location.origin}/register?ref=${window.myReferralCode}`;
            if(navigator.share) navigator.share({title:'WA Blast Pro', url});
            else navigator.clipboard.writeText(url).then(()=>Swal.fire('Disalin', 'Link referral disalin', 'success'));
        }
        function doLogout() { window.location.href = '/logout'; }
        function showAddDeviceModal() {
            try {
                if (typeof bootstrap === 'undefined') {
                    throw new Error("Bootstrap library belum termuat. Periksa koneksi internet Anda.");
                }

                document.getElementById('addDeviceForm').style.display = 'block';
                document.getElementById('scanQrArea').style.display = 'none';
                document.getElementById('newSessionName').value = '';
                document.getElementById('pairingNumber').value = '';
                toggleAuthMethod('qr');
                
                const modalEl = document.getElementById('addDeviceModal');
                const modal = bootstrap.Modal.getOrCreateInstance(modalEl);
                modal.show();
            } catch (e) {
                console.error("Error showing modal:", e);
                alert("Gagal membuka modal: " + e.message);
            }
        }

        // function confirmUpgrade() ... DISABLED for manual upgrade
        
        function showTopupModal() {
            // Load Banks First
            fetch('/api/admin/banks').then(r=>r.json()).then(banks => {
                const select = document.getElementById('topupMethod');
                select.innerHTML = '';
                if(banks.length === 0) {
                    select.innerHTML = '<option disabled>Belum ada metode pembayaran</option>';
                } else {
                    banks.forEach(b => {
                        select.innerHTML += `<option value="${b.bank_name} - ${b.account_number}" data-acc-name="${b.account_name}">${b.bank_name} (${b.account_number} a.n ${b.account_name})</option>`;
                    });
                }
                const modal = new bootstrap.Modal(document.getElementById('topupModal'));
                modal.show();
            });
        }

        document.getElementById('topupForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const amount = document.getElementById('topupAmount').value;
            const select = document.getElementById('topupMethod');
            const method = select.value;
            const selectedOption = select.options[select.selectedIndex];
            const accName = selectedOption.getAttribute('data-acc-name') || 'Admin Blast';
            
            fetchAuth('/api/topup', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ amount, payment_method: method })
            }).then(r=>r.json()).then(d => {
                if(d.status === 'success') {
                    bootstrap.Modal.getInstance(document.getElementById('topupModal')).hide();
                    
                    Swal.fire({
                        title: 'Permintaan Dibuat!',
                        html: `Silakan transfer <b>${formatRupiah(amount)}</b> ke:<br><br>
                        <b>${method}</b><br>
                        a.n. ${accName}<br><br>
                        Setelah transfer, konfirmasi ke Admin via WhatsApp/Telegram.`,
                        icon: 'success',
                        confirmButtonText: 'Konfirmasi ke Admin',
                        showCancelButton: true,
                        cancelButtonText: 'Tutup'
                    }).then((result) => {
                        if (result.isConfirmed) {
                            window.open('https://t.me/jstogel', '_blank');
                        }
                        updateWithdrawUI(); // Refresh history
                    });
                } else {
                    Swal.fire('Gagal', d.message, 'error');
                }
            });
        });

        function approveTopup(id, userId, amount) {
            Swal.fire({
                title: 'Setujui Topup?',
                text: `Saldo user akan bertambah ${formatRupiah(amount)}`,
                icon: 'question',
                showCancelButton: true,
                confirmButtonText: 'Ya, Setujui'
            }).then((result) => {
                if (result.isConfirmed) {
                    fetchAuth('/api/admin/topups/approve', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({ id, userId, amount })
                    }).then(r=>r.json()).then(d => {
                        Swal.fire(d.status === 'success' ? 'Sukses' : 'Gagal', d.message, d.status === 'success' ? 'success' : 'error');
                        loadAdminData();
                    });
                }
            });
        }
        
        // --- Admin Bank Functions ---
        document.getElementById('addBankForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const bank_name = document.getElementById('bankName').value;
            const account_number = document.getElementById('bankAccNum').value;
            const account_name = document.getElementById('bankAccName').value;
            
            fetchAuth('/api/admin/banks', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ bank_name, account_number, account_name })
            }).then(r=>r.json()).then(d => {
                if(d.status === 'success') {
                    Swal.fire('Sukses', 'Rekening ditambahkan', 'success');
                    document.getElementById('addBankForm').reset();
                    loadAdminData(); // Reload list
                }
            });
        });

        function deleteBank(id) {
            Swal.fire({
                title: 'Hapus Rekening?',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: 'Hapus'
            }).then((result) => {
                if (result.isConfirmed) {
                    fetchAuth(`/api/admin/banks/${id}`, { method: 'DELETE' })
                    .then(r=>r.json()).then(() => loadAdminData());
                }
            });
        }

        // --- Admin Functions ---
        function loadAdminData() {
            fetch('/api/admin/users').then(r=>r.json()).then(users => {
                const c = document.getElementById('membersListContainer');
                c.innerHTML = '';
                let connected = 0, disconnected = 0;
                let totalMembers = 0, totalPro = 0;

                users.forEach(u => {
                    // Stats Calculation
                    if(u.role === 'member') totalMembers++;
                    if(u.role === 'admin' || u.role === 'superadmin') totalPro++;
                    
                    if(u.connected_device_count > 0) connected += u.connected_device_count;
                    disconnected += (u.device_count - u.connected_device_count);
                    
                    const roleBadge = u.role === 'admin' ? 'bg-warning text-dark' : (u.role === 'superadmin' ? 'bg-danger' : 'bg-secondary');
                    
                    let devicesHtml = '';
                    if (u.devices && u.devices.length > 0) {
                        devicesHtml = `<div class="mt-2 border-top border-secondary border-opacity-25 pt-2">
                            <a class="text-decoration-none small text-muted" data-bs-toggle="collapse" href="#devList${u.id}" role="button">
                                <i class="bi bi-phone me-1"></i> Lihat Rincian Perangkat (${u.devices.length})
                            </a>
                            <div class="collapse mt-2" id="devList${u.id}">
                                <div class="card card-body bg-black bg-opacity-25 p-2">
                                    ${u.devices.map(d => {
                                        const statusColor = d.status === 'connected' ? 'text-success' : 'text-danger';
                                        let phoneInfo = '-';
                                        if(d.device_info) {
                                            try {
                                                const info = JSON.parse(d.device_info);
                                                phoneInfo = info.wid ? info.wid.user : 'Belum Scan';
                                            } catch(e) { phoneInfo = 'Invalid Data'; }
                                        }
                                        return `<div class="d-flex justify-content-between small mb-1">
                                            <span class="text-white-50">${d.session_name} (${phoneInfo})</span>
                                            <span class="${statusColor} fw-bold" style="font-size: 0.7rem;">${d.status.toUpperCase()}</span>
                                        </div>`;
                                    }).join('')}
                                </div>
                            </div>
                        </div>`;
                    } else {
                        devicesHtml = `<div class="mt-2 small text-muted fst-italic">Tidak ada perangkat terdaftar</div>`;
                    }

                    c.innerHTML += `
                    <div class="member-list-item p-3 mb-2 rounded border border-secondary border-opacity-25">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <span class="fw-bold text-white me-2">${u.username}</span>
                                <span class="badge ${roleBadge}">${u.role}</span>
                            </div>
                            <div class="dropdown">
                                <button class="btn btn-sm btn-link text-white" type="button" data-bs-toggle="dropdown"><i class="bi bi-three-dots-vertical"></i></button>
                                <ul class="dropdown-menu dropdown-menu-dark">
                                    <li><a class="dropdown-item" href="#" onclick="addBalance(${u.id})"><i class="bi bi-cash me-2"></i> Tambah Saldo</a></li>
                                    <li><a class="dropdown-item" href="#" onclick="changeUserRole(${u.id}, '${u.role}')"><i class="bi bi-person-badge me-2"></i> Ubah Role</a></li>
                                    <li><hr class="dropdown-divider"></li>
                                    <li><a class="dropdown-item text-danger" href="#" onclick="deleteUser(${u.id})"><i class="bi bi-trash me-2"></i> Hapus User</a></li>
                                </ul>
                            </div>
                        </div>
                        <div class="small text-secondary mt-1">
                            Saldo: ${formatRupiah(u.balance)} | Devices: ${u.connected_device_count}/${u.device_count}
                        </div>
                        ${devicesHtml}
                    </div>`;
                });
                
                // Update Stats UI
                document.getElementById('countConnected').innerText = connected;
                document.getElementById('countDisconnected').innerText = disconnected;
                document.getElementById('countTotalMembers').innerText = totalMembers;
                document.getElementById('countTotalPro').innerText = totalPro;
            });
            
            fetch('/api/admin/withdrawals').then(r=>r.json()).then(list => {
                const c = document.getElementById('adminWithdrawalsList');
                c.innerHTML = '';
                list.forEach(w => {
                    c.innerHTML += `<div class="p-3 mb-2 bg-dark border border-secondary rounded text-white">${w.username} - ${formatRupiah(w.amount)} (${w.status})</div>`;
                });
            });

            fetch('/api/admin/topups').then(r=>r.json()).then(list => {
                const c = document.getElementById('adminTopupsList');
                c.innerHTML = '';
                if(list.length === 0) c.innerHTML = '<div class="text-center text-muted py-3">Belum ada permintaan topup</div>';
                
                list.forEach(t => {
                    let actionBtn = '';
                    if(t.status === 'pending') {
                        actionBtn = `<button class="btn btn-sm btn-success ms-2" onclick="approveTopup(${t.id}, ${t.user_id}, ${t.amount})">Approve</button>`;
                    }
                    
                    const statusColor = t.status === 'success' ? 'text-success' : (t.status === 'pending' ? 'text-warning' : 'text-danger');
                    
                    c.innerHTML += `
                    <div class="p-3 mb-2 bg-dark border border-secondary rounded text-white d-flex justify-content-between align-items-center">
                        <div>
                            <div class="fw-bold">${t.username}</div>
                            <div class="small text-secondary">${t.payment_method} - ${new Date(t.created_at).toLocaleDateString()}</div>
                        </div>
                        <div class="text-end">
                            <div class="fw-bold">${formatRupiah(t.amount)}</div>
                            <div class="small ${statusColor} fw-bold">${t.status.toUpperCase()}</div>
                        </div>
                        ${actionBtn}
                    </div>`;
                });
            });

            // Load Admin Banks
            fetch('/api/admin/banks').then(r=>r.json()).then(banks => {
                const c = document.getElementById('adminBanksList');
                c.innerHTML = '';
                banks.forEach(b => {
                    c.innerHTML += `
                    <div class="p-3 mb-2 bg-dark border border-secondary rounded text-white d-flex justify-content-between align-items-center">
                        <div>
                            <div class="fw-bold">${b.bank_name}</div>
                            <div class="small text-secondary">${b.account_number} a.n ${b.account_name}</div>
                        </div>
                        <button class="btn btn-sm btn-danger" onclick="deleteBank(${b.id})"><i class="bi bi-trash"></i></button>
                    </div>`;
                });
            });
        }
        
        // --- Admin Blast Logic ---
        document.getElementById('blastForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const mode = document.getElementById('blastMode').value;
            const numbers = document.getElementById('numbers').value;
            const message = document.getElementById('message').value;
            
            // Validation
            if(!numbers.trim() || !message.trim()) {
                Swal.fire('Error', 'Nomor dan Pesan tidak boleh kosong', 'error');
                return;
            }

            Swal.fire({
                title: 'Konfirmasi Blast',
                text: `Anda akan mengirim pesan menggunakan mode: ${mode === 'global' ? 'GLOBAL (Member)' : 'SELF (Sendiri)'}. Lanjutkan?`,
                icon: 'question',
                showCancelButton: true,
                confirmButtonText: 'Kirim'
            }).then((result) => {
                if (result.isConfirmed) {
                    // Show Loading
                    Swal.fire({title: 'Memproses...', didOpen: () => Swal.showLoading()});
                    
                    fetchAuth('/send-message', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({ numbers, message, mode }) 
                    }).then(r=>r.json()).then(d => {
                        if(d.status === 'success') {
                            Swal.fire('Sukses', d.message, 'success');
                            document.getElementById('numbers').value = '';
                            document.getElementById('message').value = '';
                        } else {
                            Swal.fire('Gagal', d.message, 'error');
                        }
                    });
                }
            });
        });

        // --- Admin Actions ---
        function showAddUserModal() {
            const modal = new bootstrap.Modal(document.getElementById('addUserModal'));
            modal.show();
        }

        document.getElementById('addUserForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const username = document.getElementById('newUsername').value;
            constpassword = document.getElementById('newPassword').value;
            const role = document.getElementById('newRole').value;
            const phone = document.getElementById('newPhone').value;

            fetchAuth('/api/admin/users/add', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ username, password: document.getElementById('newPassword').value, role, phone })
            }).then(r=>r.json()).then(d => {
                if(d.status === 'success') {
                    Swal.fire('Sukses', d.message, 'success');
                    bootstrap.Modal.getInstance(document.getElementById('addUserModal')).hide();
                    loadAdminData();
                    document.getElementById('addUserForm').reset();
                } else {
                    Swal.fire('Gagal', d.message, 'error');
                }
            });
        });

        function deleteUser(id) {
            Swal.fire({
                title: 'Hapus User?',
                text: "Data dan sesi WhatsApp user ini akan dihapus permanen!",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#d33',
                confirmButtonText: 'Ya, Hapus!'
            }).then((result) => {
                if (result.isConfirmed) {
                    fetchAuth(`/api/admin/users/${id}`, { method: 'DELETE' })
                    .then(r=>r.json()).then(d => {
                        Swal.fire(d.status === 'success' ? 'Terhapus!' : 'Gagal', d.message, d.status === 'success' ? 'success' : 'error');
                        loadAdminData();
                    });
                }
            });
        }

        function changeUserRole(id, currentRole) {
            Swal.fire({
                title: 'Ubah Role User',
                input: 'select',
                inputOptions: {
                    'member': 'Member',
                    'admin': 'Admin'
                },
                inputValue: currentRole,
                showCancelButton: true,
                confirmButtonText: 'Simpan'
            }).then((result) => {
                if (result.isConfirmed) {
                    fetchAuth('/api/admin/users/update-role', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({ userId: id, role: result.value })
                    }).then(r=>r.json()).then(d => {
                        Swal.fire(d.status === 'success' ? 'Sukses' : 'Gagal', d.message, d.status === 'success' ? 'success' : 'error');
                        loadAdminData();
                    });
                }
            });
        }

        // Blast Form
        document.getElementById('blastForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const numbers = document.getElementById('numbers').value;
            const message = document.getElementById('message').value;
            const senderId = document.getElementById('senderId').value;
            fetchAuth('/send-message', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ numbers, message, senderId }),
            }).then(r => r.json()).then(d => Swal.fire(d.status, d.message, d.status));
        });

        // Withdraw Form (Tab)
        document.getElementById('wdRequestForm').addEventListener('submit', function(e){
            e.preventDefault();
            const amount = document.getElementById('wdRequestAmount').value;
            
            Swal.fire({
                title: 'Konfirmasi Penarikan',
                text: `Anda akan menarik saldo sebesar ${formatRupiah(amount)} ke rekening terdaftar. Lanjutkan?`,
                icon: 'question',
                showCancelButton: true,
                confirmButtonText: 'Ya, Tarik'
            }).then((result) => {
                if (result.isConfirmed) {
                    Swal.fire({title: 'Memproses...', didOpen: () => Swal.showLoading()});
                    
                    fetchAuth('/api/withdraw', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({ amount })
                    }).then(r=>r.json()).then(d => {
                        if(d.status === 'success') {
                            Swal.fire('Sukses', d.message, 'success');
                            document.getElementById('wdRequestForm').reset();
                            initUser(); // Refresh balance and UI
                        } else {
                            Swal.fire('Gagal', d.message, 'error');
                        }
                    });
                }
            });
        });

        // Withdraw Form (Modal - Legacy/Unused but kept for safety or if triggered elsewhere)
        document.getElementById('withdrawForm').addEventListener('submit', function(e){
            e.preventDefault();
            // Implement fetch to /api/withdraw
            Swal.fire('Info', 'Fitur withdraw akan diproses manual via admin.', 'info');
        });

        // Change Password Form (Modal)
        document.getElementById('changePasswordForm').addEventListener('submit', function(e){
            e.preventDefault();
            const oldPassword = document.getElementById('oldPassword').value;
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;

            if(newPassword !== confirmPassword) {
                return Swal.fire('Gagal', 'Konfirmasi password tidak cocok', 'error');
            }

            fetchAuth('/api/change-password', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ oldPassword, newPassword })
            }).then(r=>r.json()).then(d => {
                if(d.status === 'success') {
                    Swal.fire('Sukses', d.message, 'success');
                    bootstrap.Modal.getInstance(document.getElementById('changePasswordModal')).hide();
                    document.getElementById('changePasswordForm').reset();
                } else {
                    Swal.fire('Gagal', d.message, 'error');
                }
            });
        });

        // Profile Change Password Form (In Profile Section)
        const profilePassForm = document.getElementById('profileChangePassForm');
        if(profilePassForm) {
            profilePassForm.addEventListener('submit', function(e) {
                e.preventDefault();
                
                const oldPassword = document.getElementById('profOldPass').value;
                const newPassword = document.getElementById('profNewPass').value;
                const confirmPassword = document.getElementById('profConfirmPass').value;

                if (newPassword !== confirmPassword) {
                    Swal.fire('Error', 'Konfirmasi password baru tidak cocok!', 'error');
                    return;
                }

                if (newPassword.length < 6) {
                    Swal.fire('Error', 'Password baru minimal 6 karakter!', 'error');
                    return;
                }

                Swal.fire({
                    title: 'Memproses...',
                    didOpen: () => Swal.showLoading()
                });

                fetchAuth('/api/change-password', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ oldPassword, newPassword })
                })
                .then(r => r.json())
                .then(d => {
                    if (d.status === 'success') {
                        Swal.fire('Sukses', d.message, 'success');
                        profilePassForm.reset();
                    } else {
                        Swal.fire('Gagal', d.message, 'error');
                    }
                })
                .catch(err => {
                    Swal.fire('Error', 'Terjadi kesalahan sistem', 'error');
                });
            });
        }

        // Profile Edit Form
        document.getElementById('profileForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const bank_name = document.getElementById('profileBank').value;
            const account_number = document.getElementById('profileRek').value;
            const account_name = document.getElementById('profileName').value;

            Swal.fire({
                title: 'Menyimpan...',
                didOpen: () => Swal.showLoading()
            });

            fetchAuth('/api/me/profile', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ bank_name, account_number, account_name })
            })
            .then(r => r.json())
            .then(d => {
                if (d.status === 'success') {
                    Swal.fire('Sukses', d.message, 'success');
                } else {
                    Swal.fire('Gagal', d.message, 'error');
                }
            })
            .catch(err => {
                Swal.fire('Error', 'Terjadi kesalahan sistem', 'error');
            });
        });

        // Init
        initUser();
    </script>
</body>
</html>